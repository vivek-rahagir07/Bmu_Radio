<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMU Campus Radio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Three.js for 3D Background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"
        }
    }
    </script>

    <style>
        :root {
            --bg-dark: #020617;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(15, 23, 42, 0.7);
            --neon-red: #ef4444;
        }

        body {
            background-color: var(--bg-dark);
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid var(--glass-border);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -2px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.1);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); } 
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .equalizer-bar { animation: equalizer 1s infinite ease-in-out; }
        @keyframes equalizer {
            0% { height: 3px; } 50% { height: 12px; } 100% { height: 3px; }
        }
        .equalizer-bar:nth-child(2) { animation-delay: 0.2s; }
        .equalizer-bar:nth-child(3) { animation-delay: 0.4s; }

        @keyframes toast-in {
            from { transform: translateY(-20px) translateX(-50%); opacity: 0; }
            to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        .animate-toast { animation: toast-in 0.3s ease-out forwards; }
        
        .typewriter-cursor {
            border-right: 2px solid #ef4444;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { border-color: transparent; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Play, Pause, Mic, Music, Video, User, Plus, 
          Heart, MessageCircle, Radio, Ghost, LogOut, 
          Headphones, X, Share2, Search, Trash2, Home,
          Calendar, Send, Bell, CheckCircle, MoreVertical,
          Clock, ChevronRight, Upload, Link as LinkIcon, FileAudio, FileVideo,
          Maximize2, ExternalLink, ShieldAlert, Flag, Copy, Phone,
          UserCircle, ListMusic, PlusCircle, Briefcase, GraduationCap, Lock, Mail, Camera, AlertCircle, BellRing
        } from 'lucide-react';

        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
          onAuthStateChanged, updateProfile, signOut 
        } from 'firebase/auth';
        import { 
          getFirestore, collection, addDoc, onSnapshot, serverTimestamp, 
          query, orderBy, doc, updateDoc, deleteDoc, increment, where 
        } from 'firebase/firestore';
        import {
          getStorage, ref, uploadBytesResumable, getDownloadURL
        } from 'firebase/storage';

        // --- Firebase Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyA5qQbhXqej2Ill5jtHWgvsBpk9BsR3a7c",
          authDomain: "bmuradio.firebaseapp.com",
          databaseURL: "https://bmuradio-default-rtdb.firebaseio.com",
          projectId: "bmuradio",
          storageBucket: "bmuradio.appspot.com",
          messagingSenderId: "230545998240",
          appId: "1:230545998240:web:c1832311a2f066cb7b24c5",
          measurementId: "G-51N1VLP1DY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Mock Data for Guest Mode ---
        const MOCK_POSTS = [
            {
                id: 'mock1',
                title: 'Welcome to BMU Radio!',
                description: 'This is a demo broadcast. Log in to post your own!',
                authorName: 'Admin_Staff',
                category: 'buzz',
                broadcastType: 'live',
                createdAt: { seconds: Date.now() / 1000 },
                likes: 42,
                mediaUrl: '' 
            },
            {
                id: 'mock2',
                title: 'Campus Jazz Vibes',
                description: 'Smooth jazz for studying in the library.',
                authorName: 'JazzClub_Student',
                category: 'music',
                broadcastType: 'recorded',
                createdAt: { seconds: (Date.now() / 1000) - 3600 },
                likes: 12,
                mediaUrl: ''
            }
        ];

        const SCHEDULE_DATA = [
            { id: 4, title: "Student Council Updates", host: "Pres. Office", time: "04:00 PM", type: "News", live: false },
            { id: 5, title: "Late Night Confessions", host: "Anonymous", time: "10:00 PM", type: "Buzz", live: false },
        ];

        // --- Components ---

        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] animate-toast pointer-events-none">
                    <div className="bg-slate-800/90 backdrop-blur-md border border-indigo-500/30 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-2">
                        <CheckCircle size={16} className="text-indigo-400" />
                        <span className="text-sm font-medium">{message}</span>
                    </div>
                </div>
            );
        };

        const Footer = () => (
            <div className="mt-12 mb-24 px-6 text-center animate-fade-in pb-safe">
                <div className="relative glass-card rounded-2xl p-6 border border-white/5 overflow-hidden group">
                    <div className="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <div className="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-indigo-500/50 to-transparent"></div>

                    <div className="relative z-10">
                        <div className="flex items-center justify-center gap-2 mb-4">
                            <span className="h-[1px] w-8 bg-slate-700"></span>
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Connect</span>
                            <span className="h-[1px] w-8 bg-slate-700"></span>
                        </div>

                        <div className="flex flex-wrap justify-center gap-3 mb-6">
                            <a href="mailto:vivek.yadav25cse@bmu.edu.in" className="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-white/5 text-xs text-slate-300 hover:bg-indigo-500/20 hover:border-indigo-500/30 hover:text-white transition-all active:scale-95 group/link">
                                <Mail size={14} className="group-hover/link:text-indigo-400 transition-colors" />
                                <span>Email</span>
                            </a>
                            <a href="https://t.me/Rahagirrr" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-white/5 text-xs text-slate-300 hover:bg-blue-500/20 hover:border-blue-500/30 hover:text-white transition-all active:scale-95 group/link">
                                <Send size={14} className="group-hover/link:text-blue-400 transition-colors" />
                                <span>Telegram</span>
                            </a>
                            <a href="tel:9996445592" className="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-800/50 border border-white/5 text-xs text-slate-300 hover:bg-green-500/20 hover:border-green-500/30 hover:text-white transition-all active:scale-95 group/link">
                                <Phone size={14} className="group-hover/link:text-green-400 transition-colors" />
                                <span>Call</span>
                            </a>
                        </div>

                        <div className="pt-4 border-t border-white/5">
                            <p className="text-slate-400 text-xs flex items-center justify-center gap-1.5">
                                Crafted with <Heart size={12} className="fill-red-500 text-red-500 animate-pulse" /> by 
                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400 font-bold hover:brightness-125 transition-all cursor-default">
                                    Vivek Yadav
                                </span>
                            </p>
                            <p className="text-[10px] text-slate-600 mt-1">Â© 2025 BMU Campus Radio</p>
                        </div>
                    </div>
                </div>
            </div>
        );

        const HandWriter = () => {
            const mountRef = useRef(null);
            const [textProgress, setTextProgress] = useState(0);
            const fullText = "PLACE WHERE BMU COMMUNITY INTERACT";

            useEffect(() => {
                if (typeof THREE === 'undefined') return;
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100); 
                camera.position.z = 10;
                camera.position.y = 0;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                const width = mountRef.current.clientWidth;
                const height = 120;
                renderer.setSize(width, height);
                
                if (mountRef.current) {
                    mountRef.current.appendChild(renderer.domElement);
                }

                const handGroup = new THREE.Group();
                const penGeo = new THREE.CylinderGeometry(0.1, 0.05, 4, 12);
                penGeo.translate(0, 2, 0); 
                const penMat = new THREE.MeshBasicMaterial({ color: 0xef4444 }); 
                const pen = new THREE.Mesh(penGeo, penMat);
                pen.rotation.z = -0.3;
                pen.rotation.x = 0.3; 
                handGroup.add(pen);

                const handMat = new THREE.MeshStandardMaterial({ color: 0x334155, roughness: 0.3, metalness: 0.8 });
                const palmGeo = new THREE.BoxGeometry(1.5, 0.5, 2);
                const palm = new THREE.Mesh(palmGeo, handMat);
                palm.position.set(0.5, 2.5, 0.5);
                palm.rotation.z = -0.3;
                handGroup.add(palm);

                const fingerGeo = new THREE.BoxGeometry(0.3, 1.2, 0.3);
                for(let i=0; i<3; i++) {
                    const finger = new THREE.Mesh(fingerGeo, handMat);
                    finger.position.set(0.2 + (i*0.4), 1.8, 0.5 + (i*0.1));
                    finger.rotation.z = -0.5;
                    finger.rotation.x = 0.2;
                    handGroup.add(finger);
                }

                const thumb = new THREE.Mesh(fingerGeo, handMat);
                thumb.position.set(-0.2, 2.0, 0.2);
                thumb.rotation.z = 0.5;
                handGroup.add(thumb);

                scene.add(handGroup);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xef4444, 1, 10);
                pointLight.position.set(2, 5, 5);
                scene.add(pointLight);

                let startTime = Date.now();
                const duration = 4000;

                const animate = () => {
                    requestAnimationFrame(animate);
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    if (progress >= 1 && elapsed > duration + 2000) startTime = Date.now();

                    const startX = -6;
                    const endX = 6;
                    const currentX = startX + (endX - startX) * progress;

                    handGroup.position.x = currentX;
                    if (progress < 1) {
                        handGroup.position.y = Math.sin(elapsed * 0.02) * 0.2 - 1.5; 
                        handGroup.rotation.z = Math.sin(elapsed * 0.015) * 0.05;
                    } else {
                        handGroup.position.y += (1 - handGroup.position.y) * 0.05;
                    }

                    const charCount = Math.floor(progress * fullText.length);
                    setTextProgress(charCount);

                    renderer.render(scene, camera);
                };

                animate();

                return () => {
                    if (mountRef.current && renderer.domElement) mountRef.current.removeChild(renderer.domElement);
                    renderer.dispose();
                };
            }, []);

            return (
                <div className="w-full flex flex-col items-center justify-center mb-6 relative">
                    <div ref={mountRef} className="absolute top-0 left-0 w-full h-[120px] pointer-events-none z-20" />
                    <div className="relative z-10 h-[120px] flex items-center justify-center pt-8">
                        <h2 className="text-2xl md:text-4xl italic font-black text-white tracking-widest text-center font-mono whitespace-nowrap">
                            {fullText.substring(0, textProgress)}
                            <span className="border-r-4 border-red-500 ml-1 animate-pulse"></span>
                        </h2>
                    </div>
                </div>
            );
        };

        const Background3D = () => {
            const mountRef = useRef(null);

            useEffect(() => {
                if (typeof THREE === 'undefined') return;
                const scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x020617, 0.0035);

                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;
                camera.position.y = 1.5;
                camera.rotation.x = -0.2;

                const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                
                if (mountRef.current) mountRef.current.appendChild(renderer.domElement);

                const geometry = new THREE.PlaneGeometry(30, 30, 40, 40);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0x6366f1, 
                    wireframe: true,
                    transparent: true,
                    opacity: 0.15,
                    side: THREE.DoubleSide
                });
                const plane = new THREE.Mesh(geometry, material);
                plane.rotation.x = -Math.PI / 2;
                scene.add(plane);

                const particlesGeo = new THREE.BufferGeometry();
                const particlesCount = 400;
                const posArray = new Float32Array(particlesCount * 3);
                for(let i=0; i < particlesCount * 3; i++) {
                    posArray[i] = (Math.random() - 0.5) * 20;
                }
                particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                const particlesMat = new THREE.PointsMaterial({
                    size: 0.03,
                    color: 0xef4444, 
                    transparent: true,
                    opacity: 0.6,
                    blending: THREE.AdditiveBlending
                });
                const particlesMesh = new THREE.Points(particlesGeo, particlesMat);
                scene.add(particlesMesh);

                const animate = () => {
                    requestAnimationFrame(animate);
                    const now = Date.now() * 0.001;
                    const positions = plane.geometry.attributes.position.array;
                    
                    for (let i = 0; i < positions.length; i += 3) {
                        const x = positions[i];
                        const y = positions[i+1];
                        positions[i + 2] = Math.sin(x / 2 + now) * 0.5 + Math.sin(y / 2 + now) * 0.5;
                    }
                    plane.geometry.attributes.position.needsUpdate = true;
                    particlesMesh.rotation.y = now * 0.05;
                    particlesMesh.position.y = Math.sin(now * 0.2) * 0.5;
                    camera.position.x = Math.sin(now * 0.1) * 0.2;
                    camera.lookAt(0, 0, 0);
                    renderer.render(scene, camera);
                };
                animate();

                const handleResize = () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                };
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    if (mountRef.current && renderer.domElement) mountRef.current.removeChild(renderer.domElement);
                    geometry.dispose();
                    material.dispose();
                    particlesGeo.dispose();
                    particlesMat.dispose();
                    renderer.dispose();
                };
            }, []);

            return <div ref={mountRef} className="fixed inset-0 z-[-1]" />;
        };

        const LoginSelection = ({ onLogin, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('student');
            const [isSignUp, setIsSignUp] = useState(false);
            const [localError, setLocalError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [profileImage, setProfileImage] = useState(null);
            const fileInputRef = useRef(null);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file && file.size <= 500000) {
                    const reader = new FileReader();
                    reader.onloadend = () => setProfileImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLocalError(null);
                if (!email.endsWith('@bmu.edu.in')) {
                    setLocalError("Please login with college ID (@bmu.edu.in)");
                    return;
                }
                setIsLoading(true);
                try {
                    if (isSignUp) {
                        const userCred = await createUserWithEmailAndPassword(auth, email, password);
                        const namePart = email.split('@')[0];
                        const displayName = `${namePart.charAt(0).toUpperCase() + namePart.slice(1)}_${role}`;
                        await updateProfile(userCred.user, { displayName, photoURL: profileImage });
                        onLogin(userCred.user, role);
                    } else {
                        const userCred = await signInWithEmailAndPassword(auth, email, password);
                        const detectedRole = userCred.user.displayName?.includes('_staff') ? 'staff' : 'student';
                        onLogin(userCred.user, detectedRole);
                    }
                } catch (err) {
                    setLocalError(err.message.replace('Firebase:', '').trim());
                } finally {
                    setIsLoading(false);
                }
            };

            const handleGuestLogin = () => {
                const guestUser = {
                    uid: 'guest',
                    displayName: 'Guest_User',
                    photoURL: null,
                    isAnonymous: true
                };
                onLogin(guestUser, 'guest');
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen text-white p-6 relative overflow-hidden">
                    <div className="relative z-10 w-full max-w-sm animate-slide-up">
                        <HandWriter />
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-gradient-to-tr from-red-600 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-2xl shadow-red-900/50 animate-bounce">
                                <Radio size={40} className="text-white" />
                            </div>
                            <h1 className="text-4xl font-black tracking-tighter text-white drop-shadow-lg">BMU RADIO</h1>
                            <p className="text-slate-300 text-sm mt-1 font-medium tracking-wide">The Sound of Campus</p>
                        </div>
                        {(localError || error) && (
                            <div className="bg-red-500/20 backdrop-blur border border-red-500/50 p-3 rounded-xl mb-6 flex items-start gap-3 animate-slide-up">
                                <AlertCircle className="text-red-400 shrink-0 mt-0.5" size={18} />
                                <p className="text-xs text-red-100 font-medium">{localError || error}</p>
                            </div>
                        )}
                        <div className="glass-card p-8 rounded-3xl border border-white/10 shadow-2xl backdrop-blur-2xl">
                            <form onSubmit={handleSubmit} className="space-y-5">
                                {isSignUp && (
                                    <div className="flex flex-col items-center mb-2 animate-fade-in">
                                        <input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={handleImageChange} />
                                        <div onClick={() => fileInputRef.current.click()} className="w-20 h-20 rounded-full bg-slate-800 border-2 border-dashed border-slate-600 flex items-center justify-center cursor-pointer hover:border-red-500 overflow-hidden transition-all group relative">
                                            {profileImage ? <img src={profileImage} className="w-full h-full object-cover" /> : <Camera className="text-slate-400 group-hover:text-red-500" size={24} />}
                                            <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <Upload size={16} className="text-white" />
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div className="flex bg-slate-900/50 p-1 rounded-xl">
                                    {['student', 'staff'].map((r) => (
                                        <button key={r} type="button" onClick={() => setRole(r)} className={`flex-1 py-2.5 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all ${role === r ? (r === 'staff' ? 'bg-blue-600 text-white shadow-lg' : 'bg-red-600 text-white shadow-lg') : 'text-slate-400 hover:text-white'}`}>
                                            {r === 'student' ? <GraduationCap size={16} /> : <Briefcase size={16} />} {r.charAt(0).toUpperCase() + r.slice(1)}
                                        </button>
                                    ))}
                                </div>
                                <div className="space-y-3">
                                    <div className="relative group">
                                        <Mail className="absolute left-3 top-3.5 text-slate-500 group-focus-within:text-red-500 transition-colors" size={18} />
                                        <input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-red-500 transition-all placeholder:text-slate-600 focus:bg-slate-900/80" placeholder="college_id@bmu.edu.in" />
                                    </div>
                                    <div className="relative group">
                                        <Lock className="absolute left-3 top-3.5 text-slate-500 group-focus-within:text-red-500 transition-colors" size={18} />
                                        <input type="password" required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-slate-900/50 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-white focus:outline-none focus:border-red-500 transition-all placeholder:text-slate-600 focus:bg-slate-900/80" placeholder="Password" />
                                    </div>
                                </div>
                                <button type="submit" disabled={isLoading} className="w-full py-3.5 rounded-xl font-bold text-white shadow-lg shadow-red-900/20 flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-orange-600 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50">
                                    {isLoading ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : (isSignUp ? 'Create Profile' : 'Enter Frequency')}
                                </button>
                            </form>
                            
                            <div className="mt-6 text-center">
                                <button onClick={() => setIsSignUp(!isSignUp)} className="text-xs text-slate-400 hover:text-white transition-colors underline decoration-slate-600 underline-offset-4">
                                    {isSignUp ? "Already have an account? Login" : "New to campus? Create Profile"}
                                </button>
                            </div>

                            <div className="mt-4 text-center">
                                <button onClick={handleGuestLogin} className="text-[11px] text-slate-500 hover:text-slate-200 transition-colors">
                                    Or continue as guest (view only)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ScheduleView = ({ showToast }) => (
            <div className="p-5 pb-24 animate-fade-in" key="schedule">
                <div className="mb-6 animate-slide-up">
                    <h2 className="text-2xl font-black text-white">Broadcast Schedule</h2>
                    <p className="text-slate-400 text-sm">Don't miss a beat on campus.</p>
                </div>
                <div className="space-y-4">
                    {SCHEDULE_DATA.map((show, index) => (
                        <div key={show.id} className="glass-card rounded-2xl p-4 flex items-center gap-4 hover:bg-slate-800/50 transition-colors group animate-slide-up" style={{ animationDelay: `${index * 100}ms` }}>
                            <div className="flex flex-col items-center justify-center w-14 h-14 bg-slate-800/50 rounded-xl border border-white/5 shrink-0">
                                <span className="text-xs font-bold text-slate-400">{show.time.split(' ')[1]}</span>
                                <span className="text-lg font-black text-white">{show.time.split(' ')[0]}</span>
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1">
                                    <h3 className="font-bold text-white truncate">{show.title}</h3>
                                    {show.live && <span className="px-1.5 py-0.5 bg-red-500/20 text-red-400 text-[10px] font-bold rounded animate-pulse">LIVE</span>}
                                </div>
                                <p className="text-sm text-slate-400 flex items-center gap-1.5">
                                    <UserCircle size={12} /> {show.host}
                                    <span className="w-1 h-1 bg-slate-600 rounded-full"></span>
                                    <span className="text-slate-500">{show.type}</span>
                                </p>
                            </div>
                            <button 
                                onClick={() => showToast(`Reminder set for ${show.title}`)}
                                className="p-2 rounded-full bg-slate-800/50 text-slate-400 hover:text-red-400 hover:bg-slate-800 transition-colors active:scale-90 transform"
                            >
                                <BellRing size={18} />
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        );

        const SearchView = ({ posts, onPlay }) => {
            const [query, setQuery] = useState('');
            const filtered = posts.filter(p => 
                p.title.toLowerCase().includes(query.toLowerCase()) || 
                p.authorName?.toLowerCase().includes(query.toLowerCase()) ||
                p.category?.toLowerCase().includes(query.toLowerCase())
            );

            return (
                <div className="p-5 pb-24 animate-fade-in min-h-screen" key="search">
                    <div className="sticky top-0 z-30 bg-[#020617]/80 backdrop-blur-md py-2 -mx-5 px-5 mb-4 animate-slide-up">
                        <div className="relative group">
                            <Search className="absolute left-4 top-3.5 text-slate-500 group-focus-within:text-red-500 transition-colors" size={18} />
                            <input 
                                type="text"
                                placeholder="Search stations, hosts, vibes..."
                                value={query}
                                onChange={(e) => setQuery(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-800 text-white rounded-xl py-3 pl-11 pr-4 focus:outline-none focus:border-red-500/50 focus:ring-1 focus:ring-red-500/50 transition-all placeholder:text-slate-600"
                                autoFocus
                            />
                        </div>
                    </div>
                    <div className="space-y-4">
                        {query && filtered.length === 0 ? (
                            <div className="text-center py-10 text-slate-500 animate-fade-in">
                                <Ghost size={48} className="mx-auto mb-3 opacity-20" />
                                <p>No signals found in the void.</p>
                            </div>
                        ) : (
                            filtered.map((post, index) => (
                                <div key={post.id} className="glass-card rounded-xl p-3 flex gap-3 items-center group animate-slide-up" style={{ animationDelay: `${index * 50}ms` }}>
                                    <div 
                                        onClick={() => post.mediaUrl && onPlay({ title: post.title, artist: post.authorName, url: post.mediaUrl })}
                                        className="w-16 h-16 rounded-lg bg-slate-800 flex items-center justify-center shrink-0 cursor-pointer relative overflow-hidden group-hover:ring-2 ring-red-500/50 transition-all"
                                    >
                                        {post.authorPhoto ? <img src={post.authorPhoto} className="w-full h-full object-cover opacity-60" /> : <Radio size={24} className="text-slate-500" />}
                                        {post.mediaUrl && (
                                            <div className="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <Play size={20} className="text-white fill-current" />
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <h4 className="font-bold text-white text-sm truncate">{post.title}</h4>
                                        <p className="text-xs text-slate-400 truncate">{post.isAnonymous ? 'Anonymous' : post.authorName}</p>
                                        <div className="flex items-center gap-2 mt-1">
                                            {post.category && (
                                                <span className="text-[10px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-400">{post.category}</span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                        {!query && (
                            <div className="mt-8 animate-slide-up delay-200">
                                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Browse Categories</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {[
                                        { id: 'podcast', label: 'Podcasts', color: 'bg-orange-500/10 text-orange-500 border-orange-500/20' },
                                        { id: 'music', label: 'Music', color: 'bg-purple-500/10 text-purple-500 border-purple-500/20' },
                                        { id: 'skills', label: 'Skills', color: 'bg-blue-500/10 text-blue-500 border-blue-500/20' },
                                        { id: 'buzz', label: 'Buzz', color: 'bg-pink-500/10 text-pink-500 border-pink-500/20' },
                                    ].map((cat, i) => (
                                        <button key={cat.id} onClick={() => setQuery(cat.id)} className={`p-4 rounded-xl border font-bold text-left transition-transform hover:scale-[1.02] ${cat.color} animate-slide-up`} style={{ animationDelay: `${200 + i * 100}ms` }}>
                                            {cat.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PostCard = ({ post, onPlay, onLike, isLiked, user, onComment, onDelete, onReport }) => {
            const [animatingLike, setAnimatingLike] = useState(false);
            const [showOptions, setShowOptions] = useState(false);
            const isLive = post.broadcastType === 'live';
            const isAuthor = user.uid === post.authorId;
            const isVideo = post.mediaType === 'video';

            const handleLikeClick = (e) => {
                e.stopPropagation();
                setAnimatingLike(true);
                onLike(post.id);
                setTimeout(() => setAnimatingLike(false), 300);
            };

            const handleShare = async (e) => {
                e.stopPropagation();
                const shareData = {
                    title: `BMU Radio: ${post.title}`,
                    text: `Check out "${post.title}" by ${post.authorName} on BMU Campus Radio!`,
                    url: window.location.href 
                };
                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(shareData.text + " " + shareData.url);
                        alert("Link copied to clipboard!");
                    }
                } catch (err) { console.error(err); }
            };

            return (
                <div className="glass-card rounded-2xl p-0 mb-6 overflow-hidden hover:border-slate-600 transition-all transform hover:scale-[1.01] relative">
                    <div className="p-4">
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center border border-white/10 ${post.isAnonymous ? 'bg-slate-800' : 'bg-gradient-to-tr from-indigo-600 to-violet-600'}`}>
                                    {post.authorPhoto && !post.isAnonymous ? (
                                        <img src={post.authorPhoto} className="w-full h-full rounded-full object-cover" />
                                    ) : (
                                        post.isAnonymous ? <Ghost size={18} className="text-white" /> : <span className="text-white font-bold">{post.authorName?.charAt(0)}</span>
                                    )}
                                </div>
                                <div>
                                    <div className="flex items-center gap-1.5">
                                        <span className="text-sm font-bold text-slate-200">
                                            {post.isAnonymous ? 'Anonymous' : post.authorName?.split('_')[0]}
                                        </span>
                                        {!post.isAnonymous && (post.likes || 0) > 5 && (
                                            <CheckCircle size={12} className="text-blue-400 fill-current animate-pulse" />
                                        )}
                                    </div>
                                    <p className="text-[10px] text-slate-500 flex items-center gap-1">
                                        {post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'} 
                                        <span className="w-0.5 h-0.5 bg-slate-600 rounded-full"></span>
                                        {post.category}
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                {isLive && (
                                    <span className="flex items-center gap-1 bg-red-500/20 border border-red-500/30 text-red-400 text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse">
                                        <span className="w-1.5 h-1.5 bg-red-500 rounded-full"></span> LIVE
                                    </span>
                                )}
                                <div className="relative">
                                    <button onClick={(e) => { e.stopPropagation(); setShowOptions(!showOptions); }} className="text-slate-500 hover:text-white p-1 rounded-full hover:bg-white/5 transition-colors">
                                        <MoreVertical size={18} />
                                    </button>
                                    
                                    {showOptions && (
                                        <>
                                            <div className="fixed inset-0 z-20" onClick={(e) => { e.stopPropagation(); setShowOptions(false); }}></div>
                                            <div className="absolute right-0 top-8 w-40 bg-slate-900 border border-slate-700 rounded-xl shadow-xl z-30 overflow-hidden animate-fade-in">
                                                {isAuthor && (
                                                    <button onClick={(e) => { e.stopPropagation(); onDelete(post.id); setShowOptions(false); }} className="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-white/5 flex items-center gap-2">
                                                        <Trash2 size={16} /> Delete
                                                    </button>
                                                )}
                                                <button onClick={(e) => { e.stopPropagation(); onReport(post.id); setShowOptions(false); }} className="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-white/5 flex items-center gap-2">
                                                    <Flag size={16} /> Report
                                                </button>
                                                <button onClick={(e) => { handleShare(e); setShowOptions(false); }} className="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-white/5 flex items-center gap-2 sm:hidden">
                                                    <Share2 size={16} /> Share
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>

                        <h3 className="text-lg font-bold text-white mb-2 leading-tight">{post.title}</h3>
                        <p className="text-sm text-slate-400 line-clamp-2 mb-4">{post.description}</p>

                        {post.mediaUrl && (
                            isVideo ? (
                                <div className="relative rounded-xl overflow-hidden bg-slate-950 border border-white/5 aspect-[16/9] group hover:border-white/10 transition-colors">
                                    <video src={post.mediaUrl} controls className="w-full h-full object-cover" />
                                </div>
                            ) : (
                                <div
                                    className="relative rounded-xl overflow-hidden bg-slate-950 border border-white/5 aspect-[3/1] group hover:border-white/10 transition-colors flex items-center justify-center cursor-pointer"
                                    onClick={() => onPlay({ title: post.title, artist: post.authorName, url: post.mediaUrl })}
                                >
                                    <div className="absolute inset-0 opacity-20 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>
                                    <div className="absolute inset-0 bg-gradient-to-r from-violet-900/20 to-fuchsia-900/20"></div>
                                    <button className="relative z-10 w-12 h-12 rounded-full bg-white text-slate-950 flex items-center justify-center group-hover:scale-110 transition-transform shadow-lg shadow-white/10">
                                        <Play size={20} fill="currentColor" className="ml-1" />
                                    </button>
                                </div>
                            )
                        )}
                    </div>

                    <div className="px-4 py-3 border-t border-white/5 bg-white/[0.02] flex items-center justify-between">
                        <div className="flex gap-4">
                            <button 
                                onClick={handleLikeClick}
                                className={`flex items-center gap-1.5 text-xs font-medium transition-all ${isLiked ? 'text-red-500' : 'text-slate-500 hover:text-slate-300'} ${animatingLike ? 'animate-pop' : ''}`}
                            >
                                <Heart size={16} className={isLiked ? 'fill-current' : ''} /> {post.likes || 0}
                            </button>
                            <button 
                                onClick={(e) => { e.stopPropagation(); onComment(post); }}
                                className="flex items-center gap-1.5 text-xs font-medium text-slate-500 hover:text-slate-300 transition-colors"
                            >
                                <MessageCircle size={16} /> Comment
                            </button>
                        </div>
                        <button onClick={handleShare} className="text-slate-500 hover:text-white transition-colors">
                            <Share2 size={16} />
                        </button>
                    </div>
                </div>
            );
        };

        const MiniPlayer = ({ currentTrack, isPlaying, togglePlay, closePlayer }) => {
            if (!currentTrack || !currentTrack.url) return null;
            return (
                <div className="fixed bottom-[70px] left-2 right-2 z-[60] animate-slide-up">
                    <div className="glass-panel bg-slate-900/90 rounded-2xl p-3 flex items-center gap-3 shadow-2xl border-t border-white/10 backdrop-blur-xl">
                        <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shrink-0 shadow-lg relative overflow-hidden">
                            <div className="absolute inset-0 bg-white/10 animate-pulse"></div>
                            {isPlaying ? (
                                <div className="flex items-end gap-[2px] h-3 z-10">
                                    <div className="w-1 bg-white rounded-full equalizer-bar"></div>
                                    <div className="w-1 bg-white rounded-full equalizer-bar" style={{animationDelay:'0.1s'}}></div>
                                    <div className="w-1 bg-white rounded-full equalizer-bar" style={{animationDelay:'0.2s'}}></div>
                                </div>
                            ) : <Music size={16} className="text-white z-10" />}
                        </div>
                        <div className="flex-1 min-w-0">
                            <h4 className="font-bold text-white text-sm truncate">{currentTrack.title}</h4>
                            <p className="text-[10px] text-slate-400 truncate">{currentTrack.artist}</p>
                        </div>
                        <div className="flex items-center gap-3 pr-1">
                            <button onClick={togglePlay} className="text-white hover:text-indigo-400 transition-colors hover:scale-110 active:scale-90">
                                {isPlaying ? <Pause size={24} fill="currentColor" /> : <Play size={24} fill="currentColor" />}
                            </button>
                            <button onClick={closePlayer} className="text-slate-500 hover:text-white transition-colors">
                                <X size={18} />
                            </button>
                        </div>
                        <div className="absolute bottom-0 left-0 right-0 h-[2px] bg-white/10 overflow-hidden rounded-b-2xl">
                            <div className={`h-full bg-indigo-500 ${isPlaying ? 'w-full transition-all duration-[100s] ease-linear' : 'w-0'}`}></div>
                        </div>
                    </div>
                </div>
            );
        };

        const CommentSheet = ({ post, user, onClose }) => {
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                if (!post) return;
                
                if (user.uid === 'guest') {
                    setComments([{ id: 'c1', text: 'Nice track!', authorName: 'Guest_User', createdAt: { seconds: Date.now() / 1000 }}]);
                    return;
                }

                const q = query(
                    collection(db, 'bmu_radio_comments'),
                    where('postId', '==', post.id)
                );
                const unsub = onSnapshot(q, (snap) => {
                    const fetchedComments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    fetchedComments.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setComments(fetchedComments);
                    setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 100);
                });
                return () => unsub();
            }, [post, user]);

            const handleSend = async (e) => {
                e.preventDefault();
                if (!newComment.trim()) return;
                
                if (user.uid === 'guest') {
                    setComments([...comments, {
                        id: Date.now().toString(),
                        text: newComment,
                        authorName: 'Guest_User',
                        createdAt: { seconds: Date.now() / 1000 }
                    }]);
                    setNewComment('');
                    return;
                }

                setLoading(true);
                try {
                    await addDoc(collection(db, 'bmu_radio_comments'), {
                        postId: post.id,
                        text: newComment,
                        authorId: user.uid,
                        authorName: user.displayName,
                        authorPhoto: user.photoURL,
                        createdAt: serverTimestamp()
                    });
                    setNewComment('');
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-950/80 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="bg-[#0f172a] w-full max-w-lg h-[80vh] rounded-t-3xl sm:rounded-3xl border border-white/10 shadow-2xl relative z-10 animate-slide-up flex flex-col">
                        <div className="p-4 border-b border-white/5 flex items-center justify-between bg-slate-900/50 rounded-t-3xl">
                            <div>
                                <h3 className="font-bold text-white">Comments</h3>
                                <p className="text-xs text-slate-400">{post?.title}</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full text-slate-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {comments.length === 0 ? (
                                <div className="text-center py-10 text-slate-500">
                                    <MessageCircle size={32} className="mx-auto mb-2 opacity-50" />
                                    <p className="text-sm">Be the first to share your thoughts!</p>
                                </div>
                            ) : (
                                comments.map(comment => (
                                    <div key={comment.id} className="flex gap-3">
                                        <div className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center border border-white/10 shrink-0 overflow-hidden">
                                            {comment.authorPhoto ? <img src={comment.authorPhoto} className="w-full h-full object-cover" /> : <User size={14} className="text-slate-400" />}
                                        </div>
                                        <div className="flex-1">
                                            <div className="bg-slate-800/50 rounded-2xl rounded-tl-none p-3 border border-white/5">
                                                <p className="text-xs font-bold text-slate-300 mb-1">{comment.authorName?.split('_')[0]}</p>
                                                <p className="text-sm text-slate-100">{comment.text}</p>
                                            </div>
                                            <p className="text-[10px] text-slate-500 mt-1 ml-2">
                                                {comment.createdAt ? new Date(comment.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now'}
                                            </p>
                                        </div>
                                    </div>
                                ))
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-3 border-t border-white/5 bg-slate-900/80 backdrop-blur-md pb-safe">
                            <form onSubmit={handleSend} className="flex gap-2">
                                <input 
                                    value={newComment}
                                    onChange={(e) => setNewComment(e.target.value)}
                                    placeholder="Add a comment..."
                                    className="flex-1 bg-slate-800 border border-slate-700 rounded-full px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors placeholder:text-slate-500"
                                />
                                <button type="submit" disabled={!newComment.trim() || loading} className="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white shadow-lg disabled:opacity-50 disabled:bg-slate-700">
                                    <Send size={18} className={loading ? 'animate-pulse' : ''} />
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const NavigationBar = ({ activeView, onViewChange, onCreateClick }) => {
            const navItems = [
                { id: 'feed', label: 'Home', icon: Home },
                { id: 'search', label: 'Search', icon: Search },
                { id: 'create', label: 'Create', icon: Plus, isAction: true },
                { id: 'schedule', label: 'Schedule', icon: Calendar },
                { id: 'profile', label: 'Profile', icon: User },
            ];

            return (
                <div className="fixed bottom-0 left-0 right-0 z-50 glass-panel border-t border-white/5 pb-safe animate-slide-up">
                    <div className="flex justify-around items-center h-16 max-w-lg mx-auto px-2">
                        {navItems.map((item) => {
                            if (item.isAction) {
                                return (
                                    <button 
                                        key={item.id}
                                        onClick={onCreateClick}
                                        className="relative -top-5 bg-gradient-to-tr from-red-600 to-orange-600 w-14 h-14 rounded-full flex items-center justify-center text-white shadow-lg shadow-red-900/50 hover:scale-110 active:scale-95 transition-all"
                                    >
                                        <Plus size={28} />
                                    </button>
                                );
                            }
                            const isActive = activeView === item.id;
                            return (
                                <button 
                                    key={item.id}
                                    onClick={() => onViewChange(item.id)}
                                    className={`flex flex-col items-center justify-center w-16 gap-1 transition-all ${isActive ? 'text-red-500 scale-110' : 'text-slate-500 hover:text-slate-300'}`}
                                >
                                    <item.icon size={20} strokeWidth={isActive ? 2.5 : 2} />
                                    <span className="text-[10px] font-medium">{item.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- NEW: CreatePostModal with Firebase Storage v10 ---
        const CreatePostModal = ({ user, onClose, onCreated }) => {
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [category, setCategory] = useState('music');
            const [file, setFile] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [isAnonymous, setIsAnonymous] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [progress, setProgress] = useState(0);

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setFile(f);
                setPreviewUrl(URL.createObjectURL(f));
            };

            const handleSubmit = async (e) => {
                e?.preventDefault();
                if (!title.trim()) {
                    alert('Please add a title.');
                    return;
                }

                setUploading(true);

                let mediaUrl = '';
                let mediaType = null;

                try {
                    if (file) {
                        mediaType = file.type.startsWith('video') ? 'video' : 'audio';
                        const storagePath = `broadcasts/${user.uid}/${Date.now()}_${file.name}`;
                        const storageRef = ref(storage, storagePath);
                        const uploadTask = uploadBytesResumable(storageRef, file);

                        await new Promise((resolve, reject) => {
                            uploadTask.on('state_changed', (snapshot) => {
                                const pct = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                setProgress(Math.round(pct));
                            }, reject, resolve);
                        });

                        mediaUrl = await getDownloadURL(uploadTask.snapshot.ref);
                    }

                    const docData = {
                        title: title.trim(),
                        description: description.trim(),
                        category,
                        mediaUrl: mediaUrl || '',
                        mediaType: mediaType || '',
                        authorId: user.uid,
                        authorName: user.displayName,
                        authorPhoto: user.photoURL || null,
                        likes: 0,
                        isAnonymous,
                        broadcastType: 'recorded',
                        createdAt: serverTimestamp(),
                    };

                    await addDoc(collection(db, 'bmu_radio_posts'), docData);

                    setUploading(false);
                    onCreated && onCreated();
                    onClose();
                } catch (err) {
                    console.error(err);
                    alert('Error creating broadcast: ' + err.message);
                    setUploading(false);
                }
            };

            return (
                <div className="fixed inset-0 z-[90] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-[#020617] w-full max-w-lg rounded-t-3xl sm:rounded-3xl border border-white/10 shadow-2xl relative z-10 animate-slide-up">
                        <div className="flex items-center justify-between p-4 border-b border-white/5 bg-slate-900/60 rounded-t-3xl">
                            <div>
                                <h3 className="text-white font-bold text-lg">New Broadcast</h3>
                                <p className="text-xs text-slate-400">Share music, podcasts, or campus buzz.</p>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-white/10 text-slate-400 hover:text-white">
                                <X size={18} />
                            </button>
                        </div>

                        <form onSubmit={handleSubmit} className="p-4 space-y-4 max-h-[75vh] overflow-y-auto scrollbar-hide">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wide">Title</label>
                                <input
                                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-red-500"
                                    placeholder="What are you broadcasting?"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                />
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wide">Description</label>
                                <textarea
                                    rows="3"
                                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-red-500 resize-none"
                                    placeholder="Tell listeners what this is about..."
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wide">Category</label>
                                    <select
                                        className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2.5 text-sm text-white focus:outline-none focus:border-red-500"
                                        value={category}
                                        onChange={(e) => setCategory(e.target.value)}
                                    >
                                        <option value="music">Music</option>
                                        <option value="podcast">Podcast</option>
                                        <option value="buzz">Buzz</option>
                                        <option value="skills">Skills</option>
                                    </select>
                                </div>
                                <div className="flex items-center gap-2 mt-5">
                                    <input
                                        id="anon"
                                        type="checkbox"
                                        checked={isAnonymous}
                                        onChange={(e) => setIsAnonymous(e.target.checked)}
                                        className="w-4 h-4 rounded border-slate-600 bg-slate-900"
                                    />
                                    <label htmlFor="anon" className="text-xs text-slate-400 flex items-center gap-1">
                                        <Ghost size={14} /> Post anonymously
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">Media (optional)</label>
                                <div className="flex flex-col gap-3">
                                    <label className="flex items-center justify-between bg-slate-900 border border-dashed border-slate-700 rounded-xl px-3 py-2.5 text-sm text-slate-400 cursor-pointer hover:border-red-500 hover:bg-slate-900/80">
                                        <div className="flex items-center gap-2">
                                            <Upload size={16} />
                                            <span>{file ? file.name : 'Upload audio or video file'}</span>
                                        </div>
                                        <input
                                            type="file"
                                            accept="audio/*,video/*"
                                            className="hidden"
                                            onChange={handleFileChange}
                                        />
                                    </label>

                                    {previewUrl && (
                                        <div className="rounded-xl overflow-hidden border border-white/10 bg-slate-900">
                                            {file.type.startsWith('video') ? (
                                                <video src={previewUrl} controls className="w-full" />
                                            ) : (
                                                <audio src={previewUrl} controls className="w-full" />
                                            )}
                                        </div>
                                    )}

                                    {uploading && (
                                        <div className="flex items-center gap-3 text-xs text-slate-400">
                                            <div className="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                                <div
                                                    className="h-full bg-red-500 rounded-full transition-all"
                                                    style={{ width: `${progress}%` }}
                                                ></div>
                                            </div>
                                            <span>{progress}%</span>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="flex gap-3 pt-2">
                                <button
                                    type="submit"
                                    disabled={uploading}
                                    className="flex-1 bg-gradient-to-r from-red-600 to-orange-600 py-2.5 rounded-xl text-sm font-bold text-white shadow-lg shadow-red-900/30 hover:scale-[1.01] active:scale-[0.98] disabled:opacity-50"
                                >
                                    {uploading ? 'Broadcasting...' : 'Publish Broadcast'}
                                </button>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="px-4 py-2.5 rounded-xl text-sm font-bold text-slate-300 bg-slate-800 hover:bg-slate-700"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [activeView, setActiveView] = useState('feed');
            const [posts, setPosts] = useState([]);
            const [currentTrack, setCurrentTrack] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [showCreate, setShowCreate] = useState(false);
            const [activeCommentPost, setActiveCommentPost] = useState(null);
            const [loading, setLoading] = useState(true);
            const [likedIds, setLikedIds] = useState(new Set());
            const [toastMessage, setToastMessage] = useState(null);
            const audioRef = useRef(new Audio());

            const showToast = (msg) => {
                setToastMessage(msg);
                setTimeout(() => setToastMessage(null), 3000);
            };

            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, u => { 
                    if (u) {
                        setUser(u); 
                    } else {
                        setUser(null);
                    }
                    setLoading(false); 
                });
                
                const qPosts = query(collection(db, 'bmu_radio_posts'), orderBy('createdAt', 'desc'));
                const unsubPosts = onSnapshot(qPosts, 
                    (snap) => setPosts(snap.docs.map(d => ({ id: d.id, ...d.data() }))),
                    (error) => {
                        console.error("Firestore access failed (maybe rules/domain)", error);
                        setPosts(MOCK_POSTS);
                    }
                );

                const savedLikes = localStorage.getItem('bmu_likes');
                if(savedLikes) setLikedIds(new Set(JSON.parse(savedLikes)));

                return () => {
                    unsubAuth();
                    unsubPosts();
                };
            }, []);

            useEffect(() => {
                const audio = audioRef.current;
                const handleEnded = () => setIsPlaying(false);
                audio.addEventListener('ended', handleEnded);
                return () => audio.removeEventListener('ended', handleEnded);
            }, []);

            useEffect(() => {
                const audio = audioRef.current;
                if (currentTrack && currentTrack.url) {
                    try {
                        audio.src = currentTrack.url;
                        audio.load();
                        const playPromise = audio.play();
                        setIsPlaying(true);
                        if (playPromise !== undefined) {
                            playPromise.catch(e => {
                                console.error("Playback error:", e);
                                setIsPlaying(false);
                            });
                        }
                    } catch (e) {
                        console.error(e);
                    }
                } else {
                    audio.pause();
                    setIsPlaying(false);
                }
            }, [currentTrack]);

            const togglePlay = () => {
                const audio = audioRef.current;
                if (!currentTrack || !currentTrack.url) return;
                if (isPlaying) {
                    audio.pause();
                    setIsPlaying(false);
                } else {
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => setIsPlaying(true))
                            .catch(e => {
                                console.error("Playback error:", e);
                                setIsPlaying(false);
                            });
                    }
                }
            };

            const handleLike = async (postId) => {
                if(likedIds.has(postId)) return;
                const newLikes = new Set(likedIds);
                newLikes.add(postId);
                setLikedIds(newLikes);
                localStorage.setItem('bmu_likes', JSON.stringify([...newLikes]));
                
                if (!user || user.uid === 'guest') return;

                try {
                    await updateDoc(doc(db, 'bmu_radio_posts', postId), { likes: increment(1) });
                } catch(e) {
                    console.error("Like failed", e);
                }
            };

            const handleDeletePost = async (postId) => {
                if (!user || user.uid === 'guest') {
                    showToast("Guest cannot delete posts.");
                    return;
                }
                if(confirm("Are you sure you want to delete this broadcast?")) {
                    try {
                        await deleteDoc(doc(db, 'bmu_radio_posts', postId));
                        showToast("Broadcast deleted.");
                    } catch(err) { alert("Error deleting post"); }
                }
            };

            const handleReportPost = async (postId) => {
                showToast("Reported to admin for review.");
            };

            const handleLoginSuccess = (userObj, role) => {
                setUser(userObj);
                localStorage.setItem('bmu_user_role', role);
                if (userObj.uid === 'guest') {
                    setPosts(MOCK_POSTS);
                }
            };

            if (loading) return <div className="h-screen bg-[#020617] flex items-center justify-center text-indigo-500"><Radio className="animate-bounce" size={40} /></div>;

            if (!user) return (
                <>
                    <Background3D />
                    <LoginSelection onLogin={handleLoginSuccess} error={null} />
                </>
            );

            const userPostsCount = posts.filter(p => p.authorId === user.uid).length;

            return (
                <div className="min-h-screen pb-24 relative overflow-hidden">
                    <Background3D />
                    
                    {toastMessage && <Toast message={toastMessage} onClose={() => setToastMessage(null)} />}

                    <header className="sticky top-0 z-40 bg-[#020617]/80 backdrop-blur-xl border-b border-white/5 px-5 py-4 flex justify-between items-center animate-slide-up">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-tr from-indigo-600 to-violet-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/20">
                                <Radio size={16} />
                            </div>
                            <span className="font-bold text-lg text-white tracking-tight">BMU<span className="text-indigo-500">FM</span></span>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={async () => { await signOut(auth); window.location.reload(); }} className="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition-colors">
                                <LogOut size={14} />
                            </button>
                            <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold text-white border-2 border-[#020617] overflow-hidden">
                                {user.photoURL ? (
                                    <img src={user.photoURL} className="w-full h-full object-cover" />
                                ) : (
                                    user.displayName?.charAt(0)
                                )}
                            </div>
                        </div>
                    </header>

                    {activeView === 'feed' && (
                        <main className="px-5 py-6 max-w-xl mx-auto animate-fade-in" key="feed">
                            <div className="mb-8 animate-slide-up">
                                <h2 className="text-2xl font-black text-white mb-1">On Air Today</h2>
                                <p className="text-slate-400 text-sm">Discover what's trending on campus.</p>
                            </div>

                            <div className="bg-gradient-to-r from-red-900/40 to-orange-900/40 border border-red-500/20 rounded-2xl p-4 mb-8 flex items-center justify-between relative overflow-hidden group animate-slide-up delay-100">
                                <div className="absolute inset-0 bg-red-600/5 group-hover:bg-red-600/10 transition-colors"></div>
                                <div className="relative z-10 flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center text-white animate-pulse shadow-lg shadow-red-500/30">
                                        <Radio size={20} />
                                    </div>
                                    <div>
                                        <div className="flex items-center gap-2 mb-0.5">
                                            <span className="text-[10px] font-bold bg-red-600 text-white px-1.5 rounded uppercase tracking-wider">Live</span>
                                            <span className="text-xs font-bold text-red-200">Campus Beats</span>
                                        </div>
                                        <p className="text-sm text-red-100 font-medium">Hosting the evening jam</p>
                                    </div>
                                </div>
                                <button className="relative z-10 bg-white text-red-900 px-4 py-2 rounded-full text-xs font-bold hover:scale-105 transition-transform shadow-lg">
                                    Listen
                                </button>
                            </div>

                            {posts.length === 0 ? (
                                <div className="text-center py-20 opacity-50 animate-fade-in">
                                    <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Radio size={32} className="text-slate-500" />
                                    </div>
                                    <p className="text-slate-500">No transmissions yet.</p>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {posts.map((post, index) => (
                                        <div key={post.id} className="animate-slide-up" style={{ animationDelay: `${200 + index * 100}ms` }}>
                                            <PostCard 
                                                post={post} 
                                                onPlay={(t) => setCurrentTrack(t)}
                                                onLike={handleLike}
                                                isLiked={likedIds.has(post.id)}
                                                user={user}
                                                onComment={() => setActiveCommentPost(post)}
                                                onDelete={handleDeletePost}
                                                onReport={handleReportPost}
                                            />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    )}

                    {activeView === 'search' && <SearchView posts={posts} onPlay={(t) => setCurrentTrack(t)} />}
                    {activeView === 'schedule' && <ScheduleView showToast={showToast} />}
                    {activeView === 'profile' && (
                        <div className="p-6 text-center pt-20 animate-fade-in" key="profile">
                            <div className="w-24 h-24 bg-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl font-bold text-white shadow-2xl shadow-indigo-500/30 border-4 border-[#020617] animate-slide-up overflow-hidden">
                                {user.photoURL ? (
                                    <img src={user.photoURL} className="w-full h-full object-cover" />
                                ) : (
                                    user.displayName?.charAt(0)
                                )}
                            </div>
                            <h2 className="text-2xl font-black text-white animate-slide-up delay-100">{user.displayName}</h2>
                            <p className="text-slate-400 mb-8 animate-slide-up delay-200">Campus Broadcaster</p>
                            <div className="grid grid-cols-2 gap-4 max-w-sm mx-auto animate-slide-up delay-300">
                                <div className="glass-card p-4 rounded-2xl">
                                    <span className="block text-2xl font-black text-white">{userPostsCount}</span>
                                    <span className="text-xs text-slate-500 uppercase font-bold">Posts</span>
                                </div>
                                <div className="glass-card p-4 rounded-2xl">
                                    <span className="block text-2xl font-black text-white">{likedIds.size}</span>
                                    <span className="text-xs text-slate-500 uppercase font-bold">Liked</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {showCreate && (
                        <CreatePostModal 
                            user={user} 
                            onClose={() => setShowCreate(false)} 
                            onCreated={() => showToast('Broadcast published!')}
                        />
                    )}

                    {activeCommentPost && (
                        <CommentSheet 
                            post={activeCommentPost} 
                            user={user} 
                            onClose={() => setActiveCommentPost(null)} 
                        />
                    )}
                    
                    <Footer />

                    <MiniPlayer 
                        currentTrack={currentTrack} 
                        isPlaying={isPlaying} 
                        togglePlay={togglePlay} 
                        closePlayer={() => { audioRef.current.pause(); setCurrentTrack(null); }}
                    />

                    <NavigationBar 
                        activeView={activeView} 
                        onViewChange={setActiveView} 
                        onCreateClick={() => {
                            if(user.uid === 'guest') {
                                showToast("Guests cannot create broadcasts. Please login with college ID.");
                            } else {
                                setShowCreate(true);
                            }
                        }} 
                    />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
