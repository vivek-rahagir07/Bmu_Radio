<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMU Campus Radio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map to handle module imports in browser -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
            "firebase/analytics": "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js"
        }
    }
    </script>

    <style>
        /* Custom Scrollbar Hide */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUpFade 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes equalizer {
            0% { height: 3px; }
            50% { height: 15px; }
            100% { height: 3px; }
        }
        .equalizer-bar {
            animation: equalizer 1s infinite ease-in-out;
        }
        .equalizer-bar:nth-child(2) { animation-delay: 0.2s; }
        .equalizer-bar:nth-child(3) { animation-delay: 0.4s; }
        .equalizer-bar:nth-child(4) { animation-delay: 0.1s; }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        .modal-enter {
            animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Play, Pause, Mic, Music, Video, User, Plus, 
          Heart, MessageCircle, Radio, Ghost, LogOut, 
          Headphones, X, Share2, Volume2, Trash2, MoreHorizontal,
          Flame, Zap, Info, RadioReceiver, Upload, Link as LinkIcon, FileAudio,
          Maximize2, ExternalLink, Calendar, Send, AlertCircle, Settings, ShieldAlert,
          UserCircle, ListMusic, PlusCircle, Briefcase, GraduationCap, ChevronRight, Lock, Mail, Camera
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAnalytics, isSupported } from "firebase/analytics";
        import { 
          getAuth, 
          signInWithEmailAndPassword,
          createUserWithEmailAndPassword,
          onAuthStateChanged, 
          updateProfile,
          signOut
        } from 'firebase/auth';
        import { 
          getFirestore, 
          collection, 
          addDoc, 
          onSnapshot, 
          serverTimestamp, 
          query, 
          doc,
          updateDoc,
          deleteDoc,
          increment
        } from 'firebase/firestore';

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyA5qQbhXqej2Ill5jtHWgvsBpk9BsR3a7c",
          authDomain: "bmuradio.firebaseapp.com",
          databaseURL: "https://bmuradio-default-rtdb.firebaseio.com",
          projectId: "bmuradio",
          storageBucket: "bmuradio.firebasestorage.app",
          messagingSenderId: "230545998240",
          appId: "1:230545998240:web:c1832311a2f066cb7b24c5",
          measurementId: "G-51N1VLP1DY"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Safe Analytics Init
        let analytics;
        isSupported().then(yes => yes ? analytics = getAnalytics(app) : null);

        // --- Constants ---
        const CATEGORIES = [
          { id: 'podcast', label: 'Podcasts', icon: Mic, color: 'from-orange-400 to-orange-600', shadow: 'shadow-orange-200' },
          { id: 'music', label: 'Music', icon: Music, color: 'from-purple-400 to-purple-600', shadow: 'shadow-purple-200' },
          { id: 'skills', label: 'Skills', icon: Video, color: 'from-blue-400 to-blue-600', shadow: 'shadow-blue-200' },
          { id: 'buzz', label: 'Campus Buzz', icon: Ghost, color: 'from-pink-500 to-rose-600', shadow: 'shadow-pink-200' },
        ];

        const SAMPLE_TRACKS = [
          { title: "BMU Morning Lofi", artist: "Campus Vibes", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" },
          { title: "Student Council Update", artist: "Pres. Office", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" },
          { title: "Exam Motivation", artist: "Study Group", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" },
        ];

        // --- Helpers ---
        const getEmbedUrl = (url) => {
          if (!url) return null;
          try {
            const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|shorts\/|live\/|feature\=player_embedded&v=))([\w-]{11})/);
            if (ytMatch && ytMatch[1]) {
              return `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1&rel=0`;
            }
            const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
            if (vimeoMatch && vimeoMatch[1]) {
                return `https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1`;
            }
            return null;
          } catch (e) {
            console.error("Error parsing video URL", e);
            return null;
          }
        };

        const isVideoFile = (url) => {
            return url && (url.match(/\.(mp4|webm|ogg|mov|m4v)(\?.*)?$/i) || url.startsWith('blob:'));
        };

        // --- Custom Styles Component ---
        const Styles = () => (
          <style>{`
            @keyframes equalizer {
              0% { height: 3px; }
              50% { height: 15px; }
              100% { height: 3px; }
            }
            .equalizer-bar {
              animation: equalizer 1s infinite ease-in-out;
            }
            .equalizer-bar:nth-child(2) { animation-delay: 0.2s; }
            .equalizer-bar:nth-child(3) { animation-delay: 0.4s; }
            .equalizer-bar:nth-child(4) { animation-delay: 0.1s; }
            
            .fade-in-up {
              animation: fadeInUp 0.5s ease-out forwards;
              opacity: 0;
              transform: translateY(20px);
            }
            @keyframes fadeInUp {
              to { opacity: 1; transform: translateY(0); }
            }
            
            .glass-panel {
              background: rgba(255, 255, 255, 0.85);
              backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px);
            }
            
            .modal-enter {
                animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            @keyframes modalSlideUp {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }

            /* Animations */
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
            }
            .animate-float {
                animation: float 6s ease-in-out infinite;
            }
            
            @keyframes slideUpFade {
                from { opacity: 0; transform: translateY(40px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .animate-slide-up {
                animation: slideUpFade 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            }
          `}</style>
        );

        // --- Components ---

        const LoadingScreen = () => (
          <div className="flex flex-col items-center justify-center h-screen bg-slate-900 text-white">
            <div className="relative mb-6">
              <div className="absolute inset-0 bg-red-500 rounded-full blur-xl opacity-50 animate-pulse"></div>
              <Radio size={64} className="relative z-10 text-white animate-bounce" />
            </div>
            <h1 className="text-2xl font-black tracking-widest bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-orange-400">BMU RADIO</h1>
            <p className="text-slate-400 text-sm mt-2 font-mono">Loading Waves...</p>
          </div>
        );

        const LoginSelection = ({ onLogin, error: propError }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [role, setRole] = useState('student');
            const [isSignUp, setIsSignUp] = useState(false);
            const [localError, setLocalError] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [profileImage, setProfileImage] = useState(null); // base64 string
            const fileInputRef = useRef(null);

            const handleImageChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 500000) { // 500KB limit
                        setLocalError("Image too large. Please use an image under 500KB.");
                        return;
                    }
                    // Read file and convert to base64
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // Create an image element to resize
                        const img = new Image();
                        img.src = reader.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            // Resize to 150x150 thumbnail
                            const maxWidth = 150;
                            const maxHeight = 150;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > maxWidth) {
                                    height *= maxWidth / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width *= maxHeight / height;
                                    height = maxHeight;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            setProfileImage(canvas.toDataURL('image/jpeg', 0.8)); // Save as optimized JPEG
                        };
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLocalError(null);

                if (!email.trim().toLowerCase().endsWith('@bmu.edu.in')) {
                    setLocalError("Please login with college ID (@bmu.edu.in)");
                    return;
                }

                if (password.length < 6) {
                    setLocalError("Password must be at least 6 characters");
                    return;
                }

                setIsLoading(true);
                try {
                    if (isSignUp) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        
                        const namePart = email.split('@')[0];
                        const formattedName = namePart.charAt(0).toUpperCase() + namePart.slice(1);
                        const displayName = `${formattedName}_${role}`;

                        await updateProfile(user, { 
                            displayName: displayName,
                            photoURL: profileImage // Save the base64 image string to profile
                        });
                        
                        onLogin(user, role);
                    } else {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        const existingName = userCredential.user.displayName || '';
                        const detectedRole = existingName.includes('_staff') ? 'staff' : 'student';
                        onLogin(userCredential.user, detectedRole);
                    }
                } catch (err) {
                    console.error("Auth Error", err);
                    if (err.code === 'auth/operation-not-allowed') {
                        setLocalError("Email/Password login is not enabled in Firebase Console.");
                    } else if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        setLocalError("Invalid email or password.");
                    } else if (err.code === 'auth/email-already-in-use') {
                        setLocalError("Account already exists. Try logging in.");
                    } else {
                        setLocalError(err.message);
                    }
                } finally {
                    setIsLoading(false);
                }
            };

            return (
              <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-white p-6 relative overflow-hidden">
                <div className="absolute top-[-20%] right-[-20%] w-96 h-96 bg-red-600/20 rounded-full blur-3xl animate-pulse"></div>
                <div className="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-blue-600/20 rounded-full blur-3xl animate-pulse delay-1000"></div>

                <div className="relative z-10 w-full max-w-sm animate-slide-up">
                  <div className="text-center mb-6">
                    <div className="w-20 h-20 bg-gradient-to-br from-red-600 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-2xl shadow-red-900/50 animate-float">
                      <Radio size={40} className="text-white" />
                    </div>
                    <h1 className="text-3xl font-black tracking-widest text-white">BMU RADIO</h1>
                    <p className="text-slate-400 text-sm">Community Login</p>
                  </div>

                  {(localError || propError) && (
                    <div className="bg-red-500/20 border border-red-500/50 p-3 rounded-xl mb-6 flex items-start gap-3 animate-in fade-in slide-in-from-top-2">
                        <AlertCircle className="text-red-400 shrink-0 mt-0.5" size={18} />
                        <p className="text-xs text-red-200 font-medium">{localError || propError}</p>
                    </div>
                  )}

                  <div className="bg-slate-800/50 backdrop-blur-xl border border-slate-700 p-6 rounded-3xl shadow-xl transition-all duration-500 hover:shadow-2xl hover:border-slate-600">
                      <form onSubmit={handleSubmit} className="space-y-4">
                          
                          {/* Profile Image Upload (Sign Up Only) */}
                          {isSignUp && (
                              <div className="flex flex-col items-center mb-4 animate-in fade-in zoom-in">
                                  <input 
                                    type="file" 
                                    accept="image/*" 
                                    className="hidden" 
                                    ref={fileInputRef} 
                                    onChange={handleImageChange}
                                  />
                                  <div 
                                    onClick={() => fileInputRef.current.click()}
                                    className="relative w-20 h-20 rounded-full bg-slate-700 border-2 border-dashed border-slate-500 flex items-center justify-center cursor-pointer hover:border-red-500 overflow-hidden transition-all duration-300 hover:scale-105 group"
                                  >
                                      {profileImage ? (
                                          <img src={profileImage} alt="Profile" className="w-full h-full object-cover" />
                                      ) : (
                                          <Camera className="text-slate-400 group-hover:text-red-500 transition-colors" size={24} />
                                      )}
                                      <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                          <Plus size={20} className="text-white" />
                                      </div>
                                  </div>
                                  <p className="text-[10px] text-slate-400 mt-2">Upload Profile Photo</p>
                              </div>
                          )}

                          <div className="flex bg-slate-900 p-1 rounded-xl">
                             <button
                               type="button"
                               onClick={() => setRole('student')}
                               className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${role === 'student' ? 'bg-red-600 text-white shadow-lg transform scale-[1.02]' : 'text-slate-500 hover:text-slate-300'}`}
                             >
                               <GraduationCap size={16} /> Student
                             </button>
                             <button
                               type="button"
                               onClick={() => setRole('staff')}
                               className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${role === 'staff' ? 'bg-blue-600 text-white shadow-lg transform scale-[1.02]' : 'text-slate-500 hover:text-slate-300'}`}
                             >
                               <Briefcase size={16} /> Staff
                             </button>
                          </div>

                          <div className="space-y-3">
                              <div className="relative group">
                                  <Mail className="absolute left-3 top-3.5 text-slate-500 group-focus-within:text-red-500 transition-colors" size={18} />
                                  <input 
                                    type="email" 
                                    required
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-red-500 transition-all duration-300 focus:ring-2 focus:ring-red-500/20 focus:scale-[1.02]"
                                    placeholder="your.name@bmu.edu.in"
                                  />
                              </div>
                              <div className="relative group">
                                  <Lock className="absolute left-3 top-3.5 text-slate-500 group-focus-within:text-red-500 transition-colors" size={18} />
                                  <input 
                                    type="password" 
                                    required
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-red-500 transition-all duration-300 focus:ring-2 focus:ring-red-500/20 focus:scale-[1.02]"
                                    placeholder="Password"
                                  />
                              </div>
                          </div>

                          <button 
                            type="submit" 
                            disabled={isLoading}
                            className={`w-full py-3.5 rounded-xl font-bold text-white shadow-lg flex items-center justify-center gap-2 transition-all duration-300 transform hover:scale-[1.03] active:scale-[0.98] ${role === 'staff' ? 'bg-blue-600 hover:bg-blue-700 shadow-blue-900/20' : 'bg-red-600 hover:bg-red-700 shadow-red-900/20'} ${isLoading ? 'opacity-70 cursor-not-allowed' : ''}`}
                          >
                            {isLoading ? (
                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            ) : (
                                isSignUp ? 'Create Profile' : 'Login'
                            )}
                          </button>
                      </form>

                      <div className="mt-6 text-center">
                          <button 
                            onClick={() => { setIsSignUp(!isSignUp); setLocalError(null); setProfileImage(null); }}
                            className="text-xs text-slate-400 hover:text-white transition-colors underline decoration-slate-600 underline-offset-4 hover:decoration-white"
                          >
                              {isSignUp ? "Already have an account? Login" : "First time here? Create Profile"}
                          </button>
                      </div>
                  </div>
                </div>
              </div>
            );
        };

        const ConfigErrorScreen = ({ errorType }) => {
          return (
            <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 text-slate-800 p-6">
              <div className="bg-white p-8 rounded-3xl shadow-xl max-w-lg w-full border border-red-100">
                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-6 mx-auto text-red-600">
                  <ShieldAlert size={32} />
                </div>
                <h2 className="text-2xl font-bold text-center mb-2">Database Locked</h2>
                <div className="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                  <div className="flex items-start gap-3">
                    <AlertCircle className="text-red-600 shrink-0 mt-0.5" size={20} />
                    <div>
                      <h4 className="font-bold text-red-700 text-sm mb-1">Missing Permissions</h4>
                      <p className="text-red-600 text-xs leading-relaxed">Your Firestore Database rules are blocking access.</p>
                    </div>
                  </div>
                </div>
                <div className="space-y-4">
                  <h3 className="font-bold text-sm uppercase text-slate-400 tracking-wider">How to Fix in Firebase Console:</h3>
                    <div className="space-y-3">
                      <ol className="list-decimal list-inside space-y-2 text-sm text-slate-700 font-medium">
                        <li>Go to <strong>Firestore Database</strong> &gt; <strong>Rules</strong> tab.</li>
                        <li>Delete everything there and paste this code:</li>
                      </ol>
                      <div className="bg-slate-900 text-green-400 p-3 rounded-lg text-xs font-mono overflow-x-auto">
                        <pre>{`rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            match /{document=**} {
              allow read, write: if true;
            }
          }
        }`}</pre>
                      </div>
                    </div>
                </div>
                <button onClick={() => window.location.reload()} className="w-full mt-8 bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition-colors">I Fixed It, Refresh App</button>
              </div>
            </div>
          );
        };

        const Visualizer = () => (
          <div className="flex items-end gap-[2px] h-4">
            <div className="w-1 bg-white rounded-t-sm equalizer-bar"></div>
            <div className="w-1 bg-white rounded-t-sm equalizer-bar"></div>
            <div className="w-1 bg-white rounded-t-sm equalizer-bar"></div>
            <div className="w-1 bg-white rounded-t-sm equalizer-bar"></div>
          </div>
        );

        const InfoModal = ({ onClose }) => (
          <div className="fixed inset-0 z-[70] flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}></div>
            <div className="bg-white w-full max-w-sm rounded-3xl p-6 relative z-10 shadow-2xl animate-[scaleIn_0.3s_ease-out]">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg">About BMU Radio</h3>
                <button onClick={onClose} className="p-1 rounded-full hover:bg-slate-100"><X size={20} /></button>
              </div>
              <p className="text-slate-600 text-sm mb-4">
                This is an <span className="font-bold text-slate-900">Open Community Platform</span> for BML Munjal University students.
              </p>
              <ul className="space-y-3 text-sm text-slate-700">
                <li className="flex items-start gap-2">
                  <Mic size={16} className="mt-1 text-red-500" />
                  <span>Broadcast your own podcasts, music, or skills.</span>
                </li>
                <li className="flex items-start gap-2">
                  <Radio size={16} className="mt-1 text-red-500" />
                  <span>Go <strong>LIVE</strong> by sharing streaming links (YouTube, Meet, etc.).</span>
                </li>
                <li className="flex items-start gap-2">
                  <Ghost size={16} className="mt-1 text-slate-800" />
                  <span>Post anonymously or build your reputation.</span>
                </li>
              </ul>
              <button onClick={onClose} className="w-full mt-6 bg-slate-900 text-white py-3 rounded-xl font-bold">Got it!</button>
            </div>
          </div>
        );

        const ProfileMenu = ({ user, onClose, onViewChange, onCreateClick, role }) => {
            const handleLogout = async () => {
                await signOut(auth);
                // Clear local role preference
                localStorage.removeItem('bmu_user_role');
                window.location.reload();
            };

            return (
                <div className="absolute top-16 right-4 w-64 bg-white rounded-2xl shadow-2xl border border-slate-100 z-50 animate-in fade-in zoom-in duration-200 origin-top-right overflow-hidden">
                    <div className="p-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white">
                        <div className="flex items-center gap-3 mb-2">
                            {user.photoURL ? (
                                <img src={user.photoURL} alt="Profile" className="w-10 h-10 rounded-full border-2 border-white/30 object-cover" />
                            ) : (
                                <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center">
                                    <span className="font-bold text-lg">{user.displayName?.charAt(0) || 'U'}</span>
                                </div>
                            )}
                            <div className="flex-1 overflow-hidden">
                                <p className="font-bold text-sm truncate">{user?.displayName ? user.displayName.split('_')[0] : 'User'}</p>
                                <span className={`text-[10px] font-bold px-1.5 py-0.5 rounded text-white border border-white/20 inline-block ${role === 'staff' ? 'bg-blue-600' : 'bg-red-600'}`}>
                                    {role?.toUpperCase() || 'USER'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div className="p-2 space-y-1">
                        <button onClick={() => { onCreateClick(); onClose(); }} className="w-full text-left px-3 py-2.5 rounded-xl hover:bg-red-50 text-red-600 font-bold text-sm flex items-center gap-3 transition-colors">
                            <PlusCircle size={18} /> New Broadcast
                        </button>
                    </div>

                    <div className="h-px bg-slate-100 mx-2"></div>

                    <div className="p-2 space-y-1">
                        <button onClick={() => { onViewChange('mine'); onClose(); }} className="w-full text-left px-3 py-2.5 rounded-xl hover:bg-slate-100 text-slate-700 font-medium text-sm flex items-center gap-3 transition-colors">
                            <UserCircle size={18} /> My Broadcasts
                        </button>
                        <button onClick={() => { onViewChange('liked'); onClose(); }} className="w-full text-left px-3 py-2.5 rounded-xl hover:bg-slate-100 text-slate-700 font-medium text-sm flex items-center gap-3 transition-colors">
                            <Heart size={18} /> Liked Stations
                        </button>
                        <button onClick={() => { onViewChange('all'); onClose(); }} className="w-full text-left px-3 py-2.5 rounded-xl hover:bg-slate-100 text-slate-700 font-medium text-sm flex items-center gap-3 transition-colors">
                            <ListMusic size={18} /> Main Feed
                        </button>
                    </div>

                    <div className="h-px bg-slate-100 mx-2"></div>

                    <div className="p-2">
                        <button onClick={handleLogout} className="w-full text-left px-3 py-2.5 rounded-xl hover:bg-slate-100 text-slate-500 hover:text-slate-800 font-medium text-sm flex items-center gap-3 transition-colors">
                            <LogOut size={18} /> Sign Out
                        </button>
                    </div>
                </div>
            );
        };

        const PostDetailModal = ({ post, onClose, onPlay, user, onDelete, isLiked, onLike }) => {
            const [comments, setComments] = useState([]);
            const [newComment, setNewComment] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [likeCount, setLikeCount] = useState(post.likes || 0);

            const isOwner = user && post.authorId === user.uid;
            const isLive = post.broadcastType === 'live';
            const isAudio = post.category === 'podcast' || post.category === 'music';
            const embedUrl = getEmbedUrl(post.mediaUrl);
            const isDirectVideo = isVideoFile(post.mediaUrl);

            useEffect(() => {
                const q = query(collection(db, 'bmu_radio_comments')); 
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const allComments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const postComments = allComments.filter(c => c.postId === post.id);
                    postComments.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                    setComments(postComments);
                }, (error) => {
                    console.error("Error fetching comments:", error);
                });
                return () => unsubscribe();
            }, [post.id]);

            const handlePostComment = async (e) => {
                e.preventDefault();
                if(!newComment.trim() || !user) return;
                setIsSubmitting(true);
                try {
                    await addDoc(collection(db, 'bmu_radio_comments'), {
                        postId: post.id,
                        text: newComment,
                        authorName: user.displayName || 'Anonymous',
                        authorId: user.uid,
                        createdAt: serverTimestamp()
                    });
                    setNewComment('');
                } catch (error) {
                    console.error("Error posting comment:", error);
                    alert("Could not post comment. Check if you have permission.");
                } finally {
                    setIsSubmitting(false);
                }
            };

            const handleLikeClick = async () => {
                if (isLiked) return;
                setLikeCount(prev => prev + 1);
                onLike(post.id); // Update local state
                try {
                    const docRef = doc(db, 'bmu_radio_posts', post.id);
                    await updateDoc(docRef, { likes: increment(1) });
                } catch (err) {
                    console.error("Like failed", err);
                    setLikeCount(prev => prev - 1);
                }
            };

            const handleShare = () => {
                const text = `Check out "${post.title}" on BMU Radio!`;
                navigator.clipboard.writeText(text);
                alert("Link copied to clipboard!");
            };

            return (
                <div className="fixed inset-0 z-[80] flex items-end sm:items-center justify-center sm:p-4">
                    <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                    <div className="bg-white w-full max-w-lg h-[90vh] sm:h-[85vh] rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 flex flex-col modal-enter overflow-hidden">
                        
                        {/* Header */}
                        <div className="p-4 border-b border-slate-100 flex items-center justify-between bg-white/80 backdrop-blur sticky top-0 z-20">
                            <div className="flex items-center gap-3">
                                {post.authorPhoto ? (
                                    <img src={post.authorPhoto} className="w-8 h-8 rounded-full object-cover border border-slate-200" alt="Author" />
                                ) : (
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold ${post.isAnonymous ? 'bg-slate-800' : 'bg-red-600'}`}>
                                        {post.isAnonymous ? <Ghost size={14} /> : (post.authorName?.charAt(0) || 'U')}
                                    </div>
                                )}
                                <div className="flex flex-col">
                                    <span className="font-bold text-sm text-slate-900 line-clamp-1">{post.title}</span>
                                    <span className="text-[10px] text-slate-500">{post.isAnonymous ? 'Anonymous' : (post.authorName?.split('_')[0] || post.authorName)}</span>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                                <X size={18} className="text-slate-600" />
                            </button>
                        </div>

                        {/* Scrollable Content */}
                        <div className="flex-1 overflow-y-auto p-0 scrollbar-hide">
                            
                            {/* Media Stage */}
                            <div className="bg-slate-900 w-full min-h-[250px] flex items-center justify-center relative group">
                                {embedUrl ? (
                                    <iframe 
                                        src={embedUrl}
                                        title={post.title}
                                        className="w-full h-[250px] sm:h-[300px]" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowFullScreen
                                    ></iframe>
                                ) : isDirectVideo ? (
                                    <video src={post.mediaUrl} controls autoPlay className="w-full h-[250px] sm:h-[300px] bg-black" />
                                ) : isAudio ? (
                                     <div className="flex flex-col items-center gap-4 py-10">
                                        <div className="w-24 h-24 rounded-2xl bg-gradient-to-br from-red-600 to-orange-600 flex items-center justify-center shadow-2xl shadow-red-900/50">
                                            <Music size={48} className="text-white opacity-90" />
                                        </div>
                                        <button 
                                            onClick={() => onPlay({ title: post.title, artist: post.isAnonymous ? 'Anonymous' : post.authorName, url: post.mediaUrl })}
                                            className="px-6 py-3 bg-white text-slate-900 rounded-full font-bold flex items-center gap-2 hover:scale-105 transition-transform shadow-lg"
                                        >
                                            <Play size={20} fill="currentColor" /> Play Audio
                                        </button>
                                        <p className="text-slate-400 text-xs mt-2">Tap to listen in background</p>
                                     </div>
                                ) : (
                                    <div className="flex flex-col items-center text-slate-400 p-8 text-center">
                                        {post.mediaUrl ? (
                                            <>
                                                <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4">
                                                    <ExternalLink size={32} />
                                                </div>
                                                <p className="mb-4 text-sm max-w-[200px] truncate">{post.mediaUrl}</p>
                                                <a href={post.mediaUrl} target="_blank" rel="noreferrer" className="px-5 py-2.5 bg-red-600 text-white rounded-full text-sm font-bold hover:bg-red-700 transition-colors">
                                                    Open External Link
                                                </a>
                                            </>
                                        ) : (
                                            <>
                                                <RadioReceiver size={48} className="mb-4 opacity-50" />
                                                <p>Text Only Broadcast</p>
                                            </>
                                        )}
                                    </div>
                                )}
                                
                                {isLive && (
                                    <div className="absolute top-4 left-4 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded shadow-lg flex items-center gap-1 animate-pulse z-10">
                                        <span className="w-1.5 h-1.5 bg-white rounded-full"></span> LIVE
                                    </div>
                                )}
                            </div>

                            {/* Post Details */}
                            <div className="p-5 border-b border-slate-100">
                                 <div className="flex items-center gap-2 mb-4">
                                    <span className={`text-[10px] font-bold px-2 py-1 rounded text-white ${post.category === 'buzz' ? 'bg-pink-500' : 'bg-slate-500'}`}>
                                        {post.category?.toUpperCase()}
                                    </span>
                                    <span className="text-[10px] text-slate-400 flex items-center gap-1">
                                        <Calendar size={10} />
                                        {new Date(post.createdAt?.seconds * 1000).toLocaleDateString()}
                                    </span>
                                 </div>
                                 
                                 <h2 className="text-xl font-bold text-slate-900 mb-3">{post.title}</h2>
                                 <p className="text-slate-600 whitespace-pre-wrap leading-relaxed">{post.description}</p>
                            </div>

                            {/* Comments Section */}
                            <div className="p-5 pb-20">
                                <h3 className="font-bold text-slate-900 mb-4 flex items-center gap-2">
                                    <MessageCircle size={18} /> Comments ({comments.length})
                                </h3>
                                
                                <div className="space-y-4 mb-6">
                                    {comments.length === 0 ? (
                                        <p className="text-sm text-slate-400 italic">No comments yet. Be the first!</p>
                                    ) : (
                                        comments.map(comment => (
                                            <div key={comment.id} className="flex gap-3 text-sm">
                                                <div className="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-xs text-slate-600 shrink-0">
                                                    {comment.authorName.charAt(0)}
                                                </div>
                                                <div className="bg-slate-50 p-3 rounded-r-xl rounded-bl-xl flex-1">
                                                    <p className="font-bold text-slate-800 text-xs mb-1">{comment.authorName.split('_')[0]}</p>
                                                    <p className="text-slate-600">{comment.text}</p>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Footer Input & Actions */}
                        <div className="p-3 border-t border-slate-100 bg-white shrink-0">
                            <form onSubmit={handlePostComment} className="flex gap-2 mb-3">
                                <input 
                                    type="text" 
                                    value={newComment}
                                    onChange={(e) => setNewComment(e.target.value)}
                                    placeholder="Add a comment..."
                                    className="flex-1 bg-slate-100 border-none rounded-full px-4 text-sm focus:ring-2 focus:ring-red-500 focus:outline-none"
                                />
                                <button 
                                    type="submit" 
                                    disabled={!newComment.trim() || isSubmitting}
                                    className="p-2 bg-red-600 text-white rounded-full disabled:opacity-50 hover:bg-red-700 transition-colors"
                                >
                                    <Send size={18} />
                                </button>
                            </form>

                            <div className="flex items-center justify-between px-2">
                                <button 
                                    onClick={handleLikeClick}
                                    className={`flex items-center gap-2 text-sm font-medium transition-colors ${isLiked ? 'text-pink-600' : 'text-slate-500 hover:text-pink-600'}`}
                                >
                                    <Heart size={20} className={isLiked ? 'fill-current' : ''} /> 
                                    <span>{likeCount}</span>
                                </button>
                                
                                <div className="flex items-center gap-4">
                                     {isOwner && (
                                        <button onClick={() => { if(confirm('Delete post?')) { onDelete(post.id); onClose(); } }} className="p-2 text-slate-400 hover:text-red-600 transition-colors">
                                            <Trash2 size={20} />
                                        </button>
                                    )}
                                    <button onClick={handleShare} className="flex items-center gap-2 text-slate-500 hover:text-green-600 transition-colors font-medium text-sm">
                                         <Share2 size={20} /> <span className="hidden sm:inline">Share</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AudioPlayer = ({ currentTrack, isPlaying, togglePlay, closePlayer }) => {
          if (!currentTrack) return null;

          return (
            <div className="fixed bottom-0 left-0 right-0 z-[60] animate-in slide-in-from-bottom duration-300">
              <div className="bg-slate-900/95 backdrop-blur-md border-t border-slate-800 p-3 pb-6 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.5)] text-white">
                
                <div className="absolute top-0 left-0 w-full h-1 bg-slate-800">
                  <div 
                    className={`h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-300 ease-linear ${isPlaying ? 'w-full animate-[width_120s_linear]' : 'w-0'}`}
                  ></div>
                </div>

                <div className="max-w-md mx-auto flex items-center justify-between mt-1">
                  <div className="flex items-center gap-3 overflow-hidden">
                    <div className={`relative w-12 h-12 rounded-lg bg-gradient-to-br from-gray-800 to-black flex items-center justify-center shadow-lg border border-slate-700 overflow-hidden group`}>
                      {isPlaying ? <Visualizer /> : <Music size={20} className="text-slate-500" />}
                    </div>
                    
                    <div className="flex-1 min-w-0">
                      <h4 className="font-bold text-sm truncate text-white">{currentTrack.title}</h4>
                      <p className="text-xs text-slate-400 truncate flex items-center gap-1">
                        {currentTrack.artist} 
                        {isPlaying && <span className="inline-block w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse ml-1"></span>}
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-4">
                    <button 
                      onClick={togglePlay}
                      className="w-12 h-12 rounded-full bg-white text-slate-900 flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-lg shadow-white/10"
                    >
                      {isPlaying ? <Pause size={22} fill="currentColor" /> : <Play size={22} fill="currentColor" className="ml-1" />}
                    </button>
                    <button 
                      onClick={closePlayer} 
                      className="p-2 text-slate-500 hover:text-white hover:bg-white/10 rounded-full transition-colors"
                    >
                      <X size={20} />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const PostCard = ({ post, onPlay, user, onDelete, onClick, isLiked, onLike }) => {
          const [likeCount, setLikeCount] = useState(post.likes || 0);
          const isAudio = post.category === 'podcast' || post.category === 'music';
          const isLive = post.broadcastType === 'live';

          const handleLike = async (e) => {
            e.stopPropagation();
            if (isLiked) return;
            setLikeCount(prev => prev + 1);
            onLike(post.id); // Trigger local like update
            try {
              const docRef = doc(db, 'bmu_radio_posts', post.id);
              await updateDoc(docRef, { likes: increment(1) });
            } catch (err) {
              console.error("Like failed", err);
              setLikeCount(prev => prev - 1);
            }
          };

          const handleShare = (e) => {
            e.stopPropagation();
            const text = `Check out "${post.title}" on BMU Radio!`;
            navigator.clipboard.writeText(text);
            alert("Link copied to clipboard!");
          };

          return (
            <div 
                onClick={onClick}
                className={`bg-white rounded-2xl shadow-sm border ${isLive ? 'border-red-200 shadow-red-100' : 'border-slate-100'} overflow-hidden mb-5 fade-in-up transform transition-all hover:shadow-md hover:-translate-y-1 duration-300 cursor-pointer group`}
            >
              <div className="p-5">
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-3">
                    {post.authorPhoto ? (
                        <img src={post.authorPhoto} className="w-10 h-10 rounded-full object-cover border border-slate-100 shadow-sm" alt="Author" />
                    ) : (
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold shadow-sm ${post.isAnonymous ? 'bg-slate-800' : 'bg-gradient-to-br from-red-500 to-rose-600'}`}>
                          {post.isAnonymous ? <Ghost size={18} /> : (post.authorName?.charAt(0) || 'U')}
                        </div>
                    )}
                    <div>
                      <p className="text-sm font-bold text-slate-800 flex items-center gap-2">
                        {post.isAnonymous ? 'Anonymous' : (post.authorName?.split('_')[0] || post.authorName)}
                        {post.category === 'buzz' && <span className="bg-pink-100 text-pink-600 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider">Buzz</span>}
                      </p>
                      <div className="flex items-center gap-2">
                        <p className="text-xs text-slate-500 font-medium">
                          {new Date(post.createdAt?.seconds * 1000).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                        </p>
                        {isLive && (
                            <span className="flex items-center gap-1 bg-red-600 text-white text-[10px] font-bold px-1.5 rounded animate-pulse">
                                <span className="w-1.5 h-1.5 bg-white rounded-full"></span> LIVE
                            </span>
                        )}
                      </div>
                    </div>
                  </div>
                  <Maximize2 size={16} className="text-slate-300 group-hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100" />
                </div>

                <h3 className="font-bold text-xl mb-2 text-slate-900 leading-tight line-clamp-2">{post.title}</h3>
                <p className="text-slate-600 text-sm mb-4 whitespace-pre-wrap leading-relaxed line-clamp-3">{post.description}</p>

                {post.mediaUrl && (
                  <div className="bg-slate-50 rounded-xl p-4 border border-slate-100 flex items-center justify-between group/media hover:bg-white hover:border-red-100 hover:shadow-sm transition-all duration-300">
                    <div className="flex items-center gap-4 min-w-0">
                      <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${isAudio ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'} group-hover/media:scale-110 transition-transform`}>
                        {isAudio ? <Headphones size={24} /> : <Video size={24} />}
                      </div>
                      <div className="overflow-hidden">
                        <p className="text-sm font-bold text-slate-800 truncate">
                          {isLive ? 'Join Live Stream' : (isAudio ? 'Listen Now' : 'Watch Content')}
                        </p>
                        <p className="text-xs text-slate-500 truncate">{new URL(post.mediaUrl).hostname || 'Local Media'}</p>
                      </div>
                    </div>
                    
                    {isAudio && !isLive ? (
                      <button 
                        onClick={(e) => { e.stopPropagation(); onPlay({ title: post.title, artist: post.isAnonymous ? 'Anonymous' : post.authorName, url: post.mediaUrl }); }}
                        className="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-red-600 transition-colors shadow-lg z-10 relative"
                      >
                        <Play size={16} fill="currentColor" className="ml-0.5" />
                      </button>
                    ) : (
                        <div className={`px-4 py-2 border text-xs font-bold rounded-full transition-colors ${isLive ? 'bg-red-600 border-red-600 text-white' : 'bg-white border-slate-200 text-slate-700'}`}>
                            {isLive ? 'Join' : 'Open'}
                        </div>
                    )}
                  </div>
                )}

                <div className="flex items-center gap-6 mt-5 pt-4 border-t border-slate-50">
                  <button 
                    onClick={handleLike}
                    className={`flex items-center gap-2 text-sm font-medium transition-colors ${liked ? 'text-pink-600' : 'text-slate-400 hover:text-pink-500'}`}
                  >
                    <Heart size={18} className={`${liked ? 'fill-current animate-[ping_0.5s_cubic-bezier(0,0,0.2,1)_1]' : ''}`} /> 
                    <span>{likeCount}</span>
                  </button>
                  <button className="flex items-center gap-2 text-slate-400 hover:text-blue-500 transition-colors text-sm font-medium group/action">
                    <MessageCircle size={18} className="group-hover/action:scale-110 transition-transform" /> 
                    <span>Comment</span>
                  </button>
                  <button 
                    onClick={handleShare}
                    className="flex items-center gap-2 text-slate-400 hover:text-green-500 transition-colors text-sm ml-auto font-medium"
                  >
                    <Share2 size={18} />
                  </button>
                </div>
              </div>
            </div>
          );
        };

        const CreatePostModal = ({ onClose, user }) => {
          const [title, setTitle] = useState('');
          const [description, setDescription] = useState('');
          const [category, setCategory] = useState('podcast');
          const [broadcastType, setBroadcastType] = useState('recorded');
          const [mediaType, setMediaType] = useState('upload'); 
          const [mediaUrl, setMediaUrl] = useState('');
          const [mediaFile, setMediaFile] = useState(null);
          const [isAnonymous, setIsAnonymous] = useState(false);
          const [loading, setLoading] = useState(false);

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (!title || !description) return;

            setLoading(true);
            try {
              let finalMediaUrl = mediaUrl;
              
              if (broadcastType === 'recorded' && mediaType === 'upload' && mediaFile) {
                  finalMediaUrl = URL.createObjectURL(mediaFile);
                  console.log("Created local blob URL for testing:", finalMediaUrl);
              }

              await addDoc(collection(db, 'bmu_radio_posts'), {
                title,
                description,
                category,
                broadcastType,
                mediaUrl: finalMediaUrl || null,
                isAnonymous,
                authorId: user.uid,
                authorName: user.displayName || 'Student',
                authorPhoto: user.photoURL || null, // SAVE PHOTO URL HERE
                createdAt: serverTimestamp(),
                likes: 0
              });

              onClose();
            } catch (err) {
              console.error("Error adding post:", err);
              alert("Error saving to database: " + err.message + "\n\nIs your database permission set to allow writes?");
            } finally {
              setLoading(false);
            }
          };

          return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
              <div className="bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl relative z-10 animate-[scaleIn_0.3s_ease-out]">
                <style>{`@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }`}</style>
                
                <div className="bg-gradient-to-r from-red-600 to-orange-600 p-6 flex justify-between items-center text-white">
                  <div>
                    <h2 className="font-bold text-xl">New Broadcast</h2>
                    <p className="text-white/80 text-sm">Open Community Platform</p>
                  </div>
                  <button onClick={onClose} className="hover:bg-white/20 p-2 rounded-full transition-colors"><X size={24} /></button>
                </div>
                
                <form onSubmit={handleSubmit} className="p-6 space-y-5">
                  
                  <div className="flex bg-slate-100 p-1 rounded-xl">
                     <button
                       type="button"
                       onClick={() => setBroadcastType('recorded')}
                       className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all ${broadcastType === 'recorded' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
                     >
                       Recorded
                     </button>
                     <button
                       type="button"
                       onClick={() => setBroadcastType('live')}
                       className={`flex-1 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-1 ${broadcastType === 'live' ? 'bg-red-600 shadow-sm text-white' : 'text-slate-500 hover:text-slate-700'}`}
                     >
                       <span className={`w-2 h-2 rounded-full ${broadcastType === 'live' ? 'bg-white animate-pulse' : 'bg-slate-400'}`}></span>
                       Go Live
                     </button>
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Title</label>
                    <input 
                      type="text" 
                      value={title}
                      onChange={(e) => setTitle(e.target.value)}
                      className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 transition-all focus:bg-white"
                      placeholder={broadcastType === 'live' ? "e.g., Live Jam Session @ Hostel 3" : "e.g., My new track..."}
                      required
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                     <div>
                       <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Category</label>
                       <div className="relative">
                         <select 
                           value={category} 
                           onChange={(e) => setCategory(e.target.value)}
                           className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 text-sm appearance-none"
                         >
                           {CATEGORIES.map(cat => (
                             <option key={cat.id} value={cat.id}>{cat.label}</option>
                           ))}
                         </select>
                         <div className="absolute right-3 top-3 pointer-events-none text-slate-400"><MoreHorizontal size={16} /></div>
                       </div>
                     </div>
                     
                     <div>
                       <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">
                          {broadcastType === 'live' ? 'Stream Link' : 'Media Source'}
                       </label>
                       
                       {broadcastType === 'live' ? (
                          <input 
                            type="url" 
                            value={mediaUrl}
                            onChange={(e) => setMediaUrl(e.target.value)}
                            className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 text-sm"
                            placeholder="YouTube Live / Meet..."
                          />
                       ) : (
                          <div className="flex bg-slate-100 rounded-xl overflow-hidden border border-slate-200">
                            <button type="button" onClick={() => setMediaType('link')} className={`flex-1 py-3 flex items-center justify-center ${mediaType === 'link' ? 'bg-white text-slate-900 font-bold shadow-sm' : 'text-slate-400'}`}>
                              <LinkIcon size={18} />
                            </button>
                            <button type="button" onClick={() => setMediaType('upload')} className={`flex-1 py-3 flex items-center justify-center ${mediaType === 'upload' ? 'bg-white text-slate-900 font-bold shadow-sm' : 'text-slate-400'}`}>
                              <Upload size={18} />
                            </button>
                          </div>
                       )}
                     </div>
                  </div>

                  {broadcastType === 'recorded' && (
                    <div className="animate-[fadeIn_0.3s]">
                       {mediaType === 'link' ? (
                         <input 
                           type="url" 
                           value={mediaUrl}
                           onChange={(e) => setMediaUrl(e.target.value)}
                           className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 text-sm"
                           placeholder="Paste MP3 / YouTube Link..."
                         />
                       ) : (
                         <div className="relative w-full border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors">
                           <input 
                             type="file" 
                             accept="audio/*,video/*"
                             onChange={(e) => setMediaFile(e.target.files[0])}
                             className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                           />
                           <div className="flex flex-col items-center justify-center py-6 text-slate-500">
                             {mediaFile ? (
                               <>
                                 <FileAudio size={32} className="text-red-500 mb-2" />
                                 <span className="text-sm font-bold text-slate-900">{mediaFile.name}</span>
                                 <span className="text-xs">{(mediaFile.size / 1024 / 1024).toFixed(2)} MB</span>
                               </>
                             ) : (
                               <>
                                 <Upload size={32} className="mb-2" />
                                 <span className="text-sm font-bold">Tap to Upload File</span>
                                 <span className="text-xs">MP3, M4A, MP4 supported</span>
                               </>
                             )}
                           </div>
                         </div>
                       )}
                    </div>
                  )}

                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Description</label>
                    <textarea 
                      value={description}
                      onChange={(e) => setDescription(e.target.value)}
                      className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 h-24 resize-none transition-all focus:bg-white"
                      placeholder="What's the vibe today?"
                      required
                    />
                  </div>

                  <div className="flex items-center justify-between bg-slate-50 p-4 rounded-xl border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors" onClick={() => setIsAnonymous(!isAnonymous)}>
                    <div className="flex items-center gap-3">
                      <div className={`p-2.5 rounded-full transition-colors ${isAnonymous ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-400 shadow-sm'}`}>
                        <Ghost size={20} />
                      </div>
                      <div>
                        <p className={`text-sm font-bold transition-colors ${isAnonymous ? 'text-slate-900' : 'text-slate-600'}`}>Anonymous Mode</p>
                        <p className="text-xs text-slate-500">Hide your identity</p>
                      </div>
                    </div>
                    <div className={`w-12 h-7 rounded-full transition-colors relative ${isAnonymous ? 'bg-slate-900' : 'bg-slate-300'}`}>
                       <div className={`absolute top-1 left-1 w-5 h-5 bg-white rounded-full transition-transform shadow-sm ${isAnonymous ? 'translate-x-5' : 'translate-x-0'}`}></div>
                    </div>
                  </div>

                  <button 
                    type="submit" 
                    disabled={loading}
                    className="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-4 rounded-xl font-bold hover:shadow-lg hover:shadow-orange-200 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? (
                       <span className="flex items-center justify-center gap-2"><div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Publishing...</span>
                    ) : (broadcastType === 'live' ? 'Start Broadcast' : 'Publish Content')}
                  </button>
                </form>
              </div>
            </div>
          );
        };

        // --- Main Application ---

        function App() {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [configError, setConfigError] = useState(null);
          const [allPosts, setAllPosts] = useState([]);
          const [filteredPosts, setFilteredPosts] = useState([]);
          const [activeTab, setActiveTab] = useState('fresh'); 
          const [showCreate, setShowCreate] = useState(false);
          const [showInfo, setShowInfo] = useState(false);
          const [selectedPost, setSelectedPost] = useState(null); 
          const [currentTrack, setCurrentTrack] = useState(null);
          const [isPlaying, setIsPlaying] = useState(false);
          
          // Profile & Role State
          const [showProfileMenu, setShowProfileMenu] = useState(false);
          const [viewFilter, setViewFilter] = useState('all'); 
          const [likedIds, setLikedIds] = useState(new Set()); 
          const [userRole, setUserRole] = useState(null); // 'student' or 'staff'

          const audioRef = useRef(new Audio());

          // Handle Authentication Status
          useEffect(() => {
            const unsubscribe = onAuthStateChanged(auth, async (u) => {
              if (u) {
                 setUser(u);
                 // If already logged in, extract role from display name (e.g. "Name_student")
                 if (u.displayName && u.displayName.includes('_')) {
                     const parts = u.displayName.split('_');
                     setUserRole(parts[parts.length - 1]); // Gets 'student' or 'staff'
                 } else {
                     // Fallback/Legacy
                     const storedRole = localStorage.getItem('bmu_user_role');
                     if (storedRole) setUserRole(storedRole);
                 }
              } else {
                 setUser(null);
                 setUserRole(null);
              }
              setLoading(false);
            });
            return () => unsubscribe();
          }, []);

          // Handle Login Success from LoginSelection
          const handleLoginSuccess = (userObj, role) => {
              setUser(userObj);
              setUserRole(role);
              localStorage.setItem('bmu_user_role', role);
          };

          // Initialize Likes from Local Storage
          useEffect(() => {
              const storedLikes = localStorage.getItem('bmu_liked_posts');
              if (storedLikes) {
                  setLikedIds(new Set(JSON.parse(storedLikes)));
              }
          }, []);

          const toggleLikeLocal = (postId) => {
              const newLikes = new Set(likedIds);
              newLikes.add(postId);
              setLikedIds(newLikes);
              localStorage.setItem('bmu_liked_posts', JSON.stringify([...newLikes]));
          };

          useEffect(() => {
            if (!user) return;
            const q = query(collection(db, 'bmu_radio_posts'));
            const unsubscribe = onSnapshot(q, (snapshot) => {
              const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setAllPosts(fetched);
            }, (error) => {
                console.error("Snapshot Error:", error);
                if (error.code === 'permission-denied') {
                    setConfigError('permission');
                }
            });
            return () => unsubscribe();
          }, [user]);

          useEffect(() => {
            let result = [...allPosts];
            
            // 1. Apply View Filter (Profile Menu Overrides)
            if (viewFilter === 'mine') {
                result = result.filter(p => p.authorId === user?.uid);
            } else if (viewFilter === 'liked') {
                result = result.filter(p => likedIds.has(p.id));
            } else {
                // 2. If 'all', use standard Tab Filter
                if (activeTab === 'trending') {
                  result.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                } else if (activeTab === 'confessions') {
                  result = result.filter(p => p.category === 'buzz' || p.isAnonymous);
                } else if (activeTab === 'skills') {
                  result = result.filter(p => p.category === 'skills');
                } else {
                   // Default Sort: Live first, then date
                   result.sort((a, b) => {
                        if (a.broadcastType === 'live' && b.broadcastType !== 'live') return -1;
                        if (a.broadcastType !== 'live' && b.broadcastType === 'live') return 1;
                        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)
                    });
                }
            }

            setFilteredPosts(result);
          }, [allPosts, activeTab, viewFilter, likedIds, user]);

          useEffect(() => {
            if (currentTrack) {
              audioRef.current.src = currentTrack.url;
              audioRef.current.play().then(() => setIsPlaying(true)).catch(e => {
                  console.log("Audio play failed", e);
                  setIsPlaying(false);
                  alert("Could not play audio track. The link might be broken or inaccessible.");
              });
            } else {
              audioRef.current.pause();
              setIsPlaying(false);
            }
          }, [currentTrack]);

          const togglePlay = () => {
            if (isPlaying) audioRef.current.pause();
            else {
                audioRef.current.play().catch(e => {
                    console.error(e);
                    alert("Playback failed.");
                });
            }
            setIsPlaying(!isPlaying);
          };

          const handleDelete = async (id) => {
            if (confirm("Are you sure you want to delete this broadcast?")) {
              await deleteDoc(doc(db, 'bmu_radio_posts', id));
            }
          };

          if (loading) return <LoadingScreen />;
          if (configError) return <ConfigErrorScreen errorType={configError} />;
          
          // Show Login Selection if user is not authenticated OR hasn't selected a role
          if (!user) {
              return <LoginSelection onLogin={handleLoginSuccess} error={configError} />;
          }

          return (
            <div className="min-h-screen bg-slate-50 font-sans pb-32">
              <Styles />
              <header className="sticky top-0 z-40 glass-panel border-b border-slate-200/50 px-5 py-4 flex items-center justify-between transition-all">
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-red-600 to-orange-600 flex items-center justify-center text-white shadow-red-200 shadow-lg">
                    <Radio size={20} className="animate-[pulse_3s_infinite]" />
                  </div>
                  <h1 className="font-extrabold text-xl tracking-tight text-slate-900">BMU<span className="text-red-600">RADIO</span></h1>
                </div>
                <div className="flex items-center gap-3 relative">
                   <button onClick={() => setShowInfo(true)} className="p-2 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors">
                      <Info size={18} />
                   </button>
                  <div className="hidden md:flex items-center gap-2 bg-slate-100/80 px-4 py-1.5 rounded-full border border-slate-200">
                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span className="text-xs font-bold text-slate-600 tracking-wide">LIVE</span>
                  </div>
                  
                  {/* Profile Menu Trigger */}
                  <button 
                    onClick={() => setShowProfileMenu(!showProfileMenu)}
                    className="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition-colors"
                  >
                     {user.photoURL ? (
                         <img src={user.photoURL} className="w-full h-full object-cover rounded-full" alt="User" />
                     ) : (
                         <User size={18} />
                     )}
                  </button>

                  {/* Profile Menu Dropdown */}
                  {showProfileMenu && (
                      <ProfileMenu 
                        user={user} 
                        role={userRole}
                        onClose={() => setShowProfileMenu(false)}
                        onViewChange={(view) => {
                            setViewFilter(view);
                            setActiveTab('fresh'); // Reset tab highlights
                        }}
                        onCreateClick={() => setShowCreate(true)}
                      />
                  )}
                </div>
              </header>

              <div className="bg-slate-900 text-white p-6 pb-16 rounded-b-[2.5rem] shadow-2xl shadow-slate-900/20 mb-[-3rem] relative z-0 overflow-hidden">
                <div className="absolute top-[-50%] right-[-10%] w-96 h-96 bg-red-600/20 rounded-full blur-3xl animate-pulse"></div>
                <div className="absolute bottom-[-10%] left-[-10%] w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"></div>
                <div className="relative z-10">
                  <div className="flex justify-between items-end mb-6">
                    <div>
                      <p className="text-slate-400 text-sm font-medium mb-1">
                        {viewFilter === 'mine' ? 'My Broadcasts' : 
                         viewFilter === 'liked' ? 'Liked Stations' : 
                         'Welcome Back'}
                      </p>
                      <h2 className="text-3xl font-black bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
                        {user?.displayName ? user.displayName.split('_')[0] : 'Student'}
                      </h2>
                    </div>
                    <div className="text-right hidden sm:block">
                      <p className="text-3xl font-black text-white">{filteredPosts.length}</p>
                      <p className="text-xs text-slate-400 uppercase tracking-wider font-bold">Broadcasts</p>
                    </div>
                  </div>
                  
                  {/* Only show categories on main feed */}
                  {viewFilter === 'all' && (
                      <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar items-start snap-x">
                        {CATEGORIES.map((cat, i) => (
                          <button 
                            key={cat.id} 
                            onClick={() => setActiveTab(cat.id === 'buzz' ? 'confessions' : cat.id === 'skills' ? 'skills' : 'fresh')}
                            className="group flex flex-col items-center gap-3 min-w-[76px] snap-center"
                            style={{ animationDelay: `${i * 100}ms` }}
                          >
                            <div className={`w-16 h-16 rounded-2xl bg-gradient-to-br ${cat.color} flex items-center justify-center shadow-lg ${cat.shadow} transform transition-all duration-300 group-hover:scale-110 group-hover:rotate-3`}>
                              <cat.icon size={28} className="text-white drop-shadow-md" />
                            </div>
                            <span className="text-xs font-semibold text-slate-300 group-hover:text-white transition-colors">{cat.label}</span>
                          </button>
                        ))}
                      </div>
                  )}
                </div>
              </div>

              <main className="max-w-xl mx-auto px-5 relative z-10">
                {/* Only show live banner on main feed */}
                {viewFilter === 'all' && (
                    <div className="bg-white rounded-2xl p-5 shadow-lg shadow-slate-200/50 border border-slate-100 mb-8 flex items-center justify-between transform transition-transform hover:scale-[1.01]">
                      <div className="flex items-center gap-4">
                        <div className="w-14 h-14 bg-red-50 rounded-xl flex items-center justify-center text-red-600 relative overflow-hidden">
                           <div className="absolute bottom-0 left-0 w-full h-1 bg-red-200">
                              <div className="h-full bg-red-500 w-2/3 animate-[width_2s_ease-in-out_infinite]"></div>
                           </div>
                           <Radio size={28} />
                        </div>
                        <div>
                          <div className="flex items-center gap-2 mb-0.5">
                             <span className="inline-block w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                             <p className="text-[10px] font-bold text-red-600 uppercase tracking-widest">Live On Air</p>
                          </div>
                          <h3 className="font-bold text-slate-900 text-lg">Campus Beats</h3>
                        </div>
                      </div>
                      <button 
                        onClick={() => setCurrentTrack(SAMPLE_TRACKS[0])}
                        className="w-12 h-12 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-red-600 transition-colors shadow-xl shadow-slate-900/20"
                      >
                        <Play size={20} fill="currentColor" className="ml-1" />
                      </button>
                    </div>
                )}

                {/* Filter Tabs - Only show on Main Feed */}
                {viewFilter === 'all' && (
                    <div className="flex items-center gap-2 mb-6 bg-white/50 backdrop-blur-sm p-1 rounded-xl border border-slate-200 sticky top-[72px] z-30 shadow-sm overflow-x-auto no-scrollbar">
                      {[
                        { id: 'fresh', label: 'Community Feed', icon: Zap },
                        { id: 'trending', label: 'Trending', icon: Flame },
                        { id: 'confessions', label: 'Confessions', icon: Ghost },
                        { id: 'skills', label: 'Skills', icon: Video },
                      ].map(tab => (
                        <button 
                          key={tab.id}
                          onClick={() => setActiveTab(tab.id)}
                          className={`flex-1 flex items-center justify-center gap-2 py-2.5 px-3 rounded-lg text-xs font-bold transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-white hover:text-slate-900'}`}
                        >
                          <tab.icon size={14} />
                          {tab.label}
                        </button>
                      ))}
                    </div>
                )}

                {/* Back to Feed Button if not on main view */}
                {viewFilter !== 'all' && (
                    <button 
                        onClick={() => setViewFilter('all')}
                        className="mb-6 flex items-center gap-2 text-slate-500 hover:text-slate-800 font-bold text-sm bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200"
                    >
                        &larr; Back to Global Feed
                    </button>
                )}

                <div className="space-y-6 min-h-[300px]">
                  {filteredPosts.length === 0 ? (
                    <div className="text-center py-16 opacity-60 flex flex-col items-center animate-in fade-in zoom-in duration-500">
                      <div className="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4">
                        <Radio size={32} className="text-slate-400" />
                      </div>
                      <p className="font-bold text-slate-600 text-lg">No signals found</p>
                      <p className="text-slate-400 text-sm">
                        {viewFilter === 'mine' ? "You haven't posted yet." : 
                         viewFilter === 'liked' ? "You haven't liked any posts yet." : 
                         "Be the first to broadcast on this frequency!"}
                      </p>
                    </div>
                  ) : (
                    filteredPosts.map((post, index) => (
                      <div key={post.id} style={{ animationDelay: `${index * 100}ms` }} className="fade-in-up">
                        <PostCard 
                          post={post} 
                          onPlay={(trackInfo) => setCurrentTrack(trackInfo)}
                          onClick={() => setSelectedPost(post)}
                          user={user}
                          onDelete={handleDelete}
                          isLiked={likedIds.has(post.id)}
                          onLike={toggleLikeLocal}
                        />
                      </div>
                    ))
                  )}
                </div>
              </main>

              <button 
                onClick={() => setShowCreate(true)}
                className="fixed bottom-24 right-6 w-16 h-16 bg-gradient-to-br from-red-600 to-orange-600 text-white rounded-full shadow-2xl shadow-red-500/40 flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-40 group"
              >
                <Plus size={32} className="group-hover:rotate-90 transition-transform duration-300" />
              </button>

              {showCreate && (
                <CreatePostModal 
                  user={user} 
                  onClose={() => setShowCreate(false)} 
                />
              )}
              
              {showInfo && <InfoModal onClose={() => setShowInfo(false)} />}
              
              {selectedPost && (
                  <PostDetailModal 
                    post={selectedPost} 
                    user={user}
                    onClose={() => setSelectedPost(null)}
                    onDelete={handleDelete}
                    onPlay={(trackInfo) => setCurrentTrack(trackInfo)}
                    isLiked={likedIds.has(selectedPost.id)}
                    onLike={toggleLikeLocal}
                  />
              )}

              <AudioPlayer 
                currentTrack={currentTrack} 
                isPlaying={isPlaying} 
                togglePlay={togglePlay}
                closePlayer={() => {
                  audioRef.current.pause();
                  setCurrentTrack(null);
                }}
              />
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>